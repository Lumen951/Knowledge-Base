# Docker å®¹å™¨åŒ–åŸºç¡€è¯¦è§£

> **é€‚åˆäººç¾¤**ï¼šäº†è§£åŸºæœ¬å‘½ä»¤è¡Œæ“ä½œçš„å¼€å‘è€…
>
> **å­¦ä¹ æ—¶é•¿**ï¼šçº¦ 45-55 åˆ†é’Ÿ
>
> **å…ˆä¿®çŸ¥è¯†**ï¼šLinux åŸºç¡€å‘½ä»¤ã€åº”ç”¨ç¨‹åºéƒ¨ç½²æ¦‚å¿µã€ç¯å¢ƒå˜é‡æ¦‚å¿µ

---

## ğŸ“Œ ä»€ä¹ˆæ˜¯ Dockerï¼Ÿ

**ä¸€å¥è¯è§£é‡Š**ï¼šDocker æ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼Œè®©å¼€å‘è€…å¯ä»¥æ‰“åŒ…åº”ç”¨åŠå…¶ä¾èµ–åˆ°ä¸€ä¸ªå¯ç§»æ¤çš„å®¹å™¨ä¸­ï¼Œç„¶ååœ¨ä»»ä½•æ”¯æŒ Docker çš„æœºå™¨ä¸Šè¿è¡Œã€‚

### ä¸ºä»€ä¹ˆéœ€è¦ Dockerï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼šä½ å¼€å‘äº†ä¸€ä¸ªåº”ç”¨ï¼Œåœ¨è‡ªå·±ç”µè„‘ä¸Šè¿è¡Œæ­£å¸¸ï¼Œä½†éƒ¨ç½²åˆ°æœåŠ¡å™¨åå‡ºç°å„ç§é—®é¢˜ï¼š

**ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼ï¼ˆæ‰‹åŠ¨é…ç½®ï¼‰**ï¼š
```bash
# åœ¨å¼€å‘ç¯å¢ƒï¼ˆWindows/macOSï¼‰
npm install
npm run dev
# âœ… è¿è¡Œæ­£å¸¸

# éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆUbuntu Linuxï¼‰
npm install
npm run dev
# âŒ é—®é¢˜ï¼š
# - Node.js ç‰ˆæœ¬ä¸åŒï¼ˆæœ¬åœ°18ï¼ŒæœåŠ¡å™¨16ï¼‰
# - ç³»ç»Ÿä¾èµ–ç¼ºå¤±ï¼ˆlibcç‰ˆæœ¬ä¸åŒï¼‰
# - ç¯å¢ƒå˜é‡é…ç½®ä¸åŒ
# - æ–‡ä»¶è·¯å¾„å·®å¼‚ï¼ˆWindows vs Linuxï¼‰
# - æƒé™é—®é¢˜ï¼ˆå¼€å‘ç¯å¢ƒrootï¼Œç”Ÿäº§ç¯å¢ƒæ™®é€šç”¨æˆ·ï¼‰
```

**Docker éƒ¨ç½²æ–¹å¼**ï¼š
```bash
# å¼€å‘ç¯å¢ƒï¼šæ„å»ºé•œåƒ
docker build -t my-app .
docker run my-app
# âœ… è¿è¡Œæ­£å¸¸

# ç”Ÿäº§æœåŠ¡å™¨ï¼šè¿è¡Œç›¸åŒé•œåƒ
docker run my-app
# âœ… å®Œå…¨ä¸€è‡´çš„ç¯å¢ƒï¼Œç«‹å³è¿è¡Œï¼

# ä¼˜åŠ¿ï¼š
# âœ… ç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ç›¸åŒ
# âœ… ä¾èµ–éš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹ï¼Œä¸ä¼šäº’ç›¸å¹²æ‰°
# âœ… å¿«é€Ÿéƒ¨ç½²ï¼šä¸€æ¡å‘½ä»¤å¯åŠ¨åº”ç”¨
# âœ… ç‰ˆæœ¬æ§åˆ¶ï¼šé•œåƒå¯ä»¥æ‰“æ ‡ç­¾ï¼Œå›æ»šå®¹æ˜“
```

### åœ¨ InnoLiber é¡¹ç›®ä¸­çš„åº”ç”¨

åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼ŒDocker è´Ÿè´£ï¼š
- âœ… **åç«¯å®¹å™¨åŒ–**ï¼šFastAPI + Poetry + PostgreSQL é©±åŠ¨
- âœ… **å‰ç«¯å®¹å™¨åŒ–**ï¼šReact + Vite æ„å»º + Nginx æœåŠ¡
- âœ… **å¤šæœåŠ¡ç¼–æ’**ï¼šPostgreSQLã€Redisã€åç«¯ã€å‰ç«¯ã€Celeryã€pgAdmin 6ä¸ªæœåŠ¡
- âœ… **å¼€å‘ç¯å¢ƒä¸€è‡´æ€§**ï¼šæ‰€æœ‰å›¢é˜Ÿæˆå‘˜è¿è¡Œç›¸åŒçš„æ•°æ®åº“å’Œç¼“å­˜ç‰ˆæœ¬

**é¡¹ç›®æ–‡ä»¶ä½ç½®**ï¼š
- åç«¯é•œåƒï¼š`backend/Dockerfile`
- å‰ç«¯é•œåƒï¼š`frontend/Dockerfile`
- æœåŠ¡ç¼–æ’ï¼š`docker-compose.yml`

---

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µï¼ˆç”¨æ—¥å¸¸è¯­è¨€ç†è§£ï¼‰

### 1. Docker ä¸‰å¤§åŸºç¡€æ¦‚å¿µ = é›†è£…ç®±è¿è¾“ç³»ç»Ÿ

**ç±»æ¯”**ï¼šDocker å°±åƒç°ä»£ç‰©æµçš„é›†è£…ç®±ç³»ç»Ÿï¼Œå®ç°äº†åº”ç”¨çš„æ ‡å‡†åŒ–æ‰“åŒ…å’Œè¿è¾“ã€‚

#### **é•œåƒï¼ˆImageï¼‰= èœè°±**

**ç±»æ¯”**ï¼šDocker é•œåƒå°±åƒçƒ¹é¥ªèœè°±ï¼Œè®°å½•äº†åˆ¶ä½œåº”ç”¨çš„æ¯ä¸€æ­¥ã€‚

**ç‰¹ç‚¹**ï¼š
- åªè¯»æ¨¡æ¿ï¼ˆRead-only Templateï¼‰
- åˆ†å±‚ç»“æ„ï¼ˆLayered Architectureï¼‰
- å¯ä»¥å…±äº«å’Œå¤ç”¨åŸºç¡€å±‚

**é¡¹ç›®å®ä¾‹**ï¼ˆæ¥è‡ª `backend/Dockerfile:1-42`ï¼‰ï¼š

```dockerfile
# ============================================================================
# Stage 1: Builder - "å‡†å¤‡é£Ÿæ" é˜¶æ®µ
# ============================================================================
FROM python:3.11-slim-bookworm AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£… Poetryï¼ˆPython åŒ…ç®¡ç†å·¥å…·ï¼‰
ENV POETRY_VERSION=1.7.1 \
    POETRY_HOME="/opt/poetry" \
    POETRY_VIRTUALENVS_IN_PROJECT=1 \
    POETRY_NO_INTERACTION=1

# ğŸ”‘ ç¬¬ä¸€å±‚ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# ğŸ”‘ ç¬¬äºŒå±‚ï¼šå®‰è£… Poetry
RUN curl -sSL https://install.python-poetry.org | python3 - \
    && ln -s ${POETRY_HOME}/bin/poetry /usr/local/bin/poetry

# ğŸ”‘ ç¬¬ä¸‰å±‚ï¼šå¤åˆ¶ä¾èµ–é…ç½®æ–‡ä»¶
COPY pyproject.toml poetry.lock ./

# ğŸ”‘ ç¬¬å››å±‚ï¼šå®‰è£… Python ä¾èµ–
RUN poetry install --no-root --only main

# ============================================================================
# Stage 2: Runtime - "ä¸Šèœ" é˜¶æ®µ
# ============================================================================
FROM python:3.11-slim-bookworm AS runtime

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ğŸ”‘ å®‰å…¨å®è·µï¼šåˆ›å»ºé root ç”¨æˆ·
RUN useradd -m -u 1000 appuser

# ğŸ”‘ å¤åˆ¶è™šæ‹Ÿç¯å¢ƒï¼ˆä» builder é˜¶æ®µï¼‰
ENV VIRTUAL_ENV=/app/.venv \
    PATH="/app/.venv/bin:$PATH"
COPY --from=builder --chown=appuser:appuser ${VIRTUAL_ENV} ${VIRTUAL_ENV}

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=appuser:appuser ./app /app/app
COPY --chown=appuser:appuser ./alembic /app/alembic
COPY --chown=appuser:appuser ./alembic.ini /app/alembic.ini

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8000

# ğŸ”‘ å¥åº·æ£€æŸ¥ï¼ˆHealth Checkï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health', timeout=2)"

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--proxy-headers"]
```

**é•œåƒçš„åˆ†å±‚ç»“æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 5: CMD (å¯åŠ¨å‘½ä»¤)             â”‚  â† æœ€ä¸Šå±‚ï¼ˆå¯ä¿®æ”¹ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: COPY åº”ç”¨ä»£ç               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: Python ä¾èµ–åŒ…              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: Poetry å·¥å…·                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1: ç³»ç»Ÿä¾èµ–ï¼ˆcurl, gcc ç­‰ï¼‰  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 0: python:3.11-slim-bookworm  â”‚  â† åŸºç¡€é•œåƒï¼ˆå®˜æ–¹ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆä½¿ç”¨åˆ†å±‚ï¼Ÿ**
- **å¤ç”¨**ï¼šå¤šä¸ªé•œåƒå¯ä»¥å…±äº«åŸºç¡€å±‚ï¼ˆå¦‚ Python 3.11 åŸºç¡€é•œåƒï¼‰
- **æ•ˆç‡**ï¼šåªä¼ è¾“å˜åŒ–çš„å±‚ï¼ŒèŠ‚çœå¸¦å®½å’Œæ—¶é—´
- **ç¼“å­˜**ï¼šæ„å»ºæ—¶æœªä¿®æ”¹çš„å±‚ä½¿ç”¨ç¼“å­˜ï¼ŒåŠ å¿«æ„å»ºé€Ÿåº¦

#### **å®¹å™¨ï¼ˆContainerï¼‰= è¿è¡Œä¸­çš„èœè‚´**

**ç±»æ¯”**ï¼šå®¹å™¨å°±åƒæ ¹æ®èœè°±ï¼ˆé•œåƒï¼‰å®é™…åšå‡ºæ¥çš„èœï¼Œå¯ä»¥é£Ÿç”¨ï¼ˆè¿è¡Œï¼‰ã€‚

**ç‰¹ç‚¹**ï¼š
- é•œåƒçš„è¿è¡Œå®ä¾‹ï¼ˆRunning Instanceï¼‰
- å¯è¯»å†™å±‚ï¼ˆWritable Layerï¼‰
- ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œå’Œè¿›ç¨‹ç©ºé—´

**å®¹å™¨ vs é•œåƒ**ï¼š
```
é•œåƒï¼ˆImageï¼‰              å®¹å™¨ï¼ˆContainerï¼‰
â””â”€ é™æ€çš„æ¨¡æ¿              â””â”€ åŠ¨æ€çš„å®ä¾‹
â””â”€ åªè¯»                    â””â”€ å¯è¯»å†™
â””â”€ ç±»ä¼¼ï¼šç±»ï¼ˆClassï¼‰       â””â”€ ç±»ä¼¼ï¼šå¯¹è±¡ï¼ˆObjectï¼‰
â””â”€ ä¸€ä¸ªé•œåƒ                â””â”€ å¯ä»¥å¯åŠ¨å¤šä¸ªå®¹å™¨

# ç¤ºä¾‹ï¼š
docker run --name backend1 my-backend-image  # å®¹å™¨1
docker run --name backend2 my-backend-image  # å®¹å™¨2
# ä¸¤ä¸ªç‹¬ç«‹çš„å®¹å™¨ï¼Œè¿è¡Œç›¸åŒçš„é•œåƒ
```

#### **ä»“åº“ï¼ˆRegistryï¼‰= èœè°±åˆ†äº«å¹³å°**

**ç±»æ¯”**ï¼šDocker Hub å°±åƒçƒ¹é¥ªç½‘ç«™ï¼Œå¤§å®¶å¯ä»¥ä¸Šä¼ å’Œä¸‹è½½èœè°±ï¼ˆé•œåƒï¼‰ã€‚

**å¸¸è§ä»“åº“**ï¼š
- **Docker Hub**ï¼šhttps://hub.docker.com/ - å®˜æ–¹å…¬å…±ä»“åº“
- **é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡**ï¼šå›½å†…é•œåƒåŠ é€Ÿ
- **ç§æœ‰ä»“åº“**ï¼šä¼ä¸šå†…éƒ¨é•œåƒå­˜å‚¨

**é¡¹ç›®å®ä¾‹**ï¼š
```dockerfile
# ä» Docker Hub æ‹‰å–åŸºç¡€é•œåƒ
FROM python:3.11-slim-bookworm      # å®Œæ•´è·¯å¾„ï¼šdocker.io/library/python:3.11-slim-bookworm
FROM pgvector/pgvector:pg16         # å®Œæ•´è·¯å¾„ï¼šdocker.io/pgvector/pgvector:pg16
FROM node:20-alpine                 # å®Œæ•´è·¯å¾„ï¼šdocker.io/library/node:20-alpine
FROM nginx:1.25-alpine              # å®Œæ•´è·¯å¾„ï¼šdocker.io/library/nginx:1.25-alpine
```

---

### 2. Dockerfile = è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬

**ç±»æ¯”**ï¼šDockerfile å°±åƒä¸€ä»½è¯¦ç»†çš„çƒ¹é¥ªæ­¥éª¤ï¼Œå‘Šè¯‰ Docker å¦‚ä½•ä¸€æ­¥æ­¥åˆ¶ä½œé•œåƒã€‚

#### **Dockerfile æ ¸å¿ƒæŒ‡ä»¤**

**é¡¹ç›®å®ä¾‹**ï¼ˆæ¥è‡ª `frontend/Dockerfile:1-64`ï¼‰ï¼š

```dockerfile
# ============================================================================
# Stage 1: Builder - æ„å»ºå‰ç«¯èµ„æº
# ============================================================================
FROM node:20-alpine AS builder

# ğŸ”‘ ARGï¼šæ„å»ºæ—¶å‚æ•°ï¼ˆå¯ä»¥åœ¨æ„å»ºæ—¶ä¼ å…¥ï¼‰
ARG NODE_ENV=production

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ğŸ”‘ COPYï¼šå¤åˆ¶æ–‡ä»¶åˆ°é•œåƒ
COPY package*.json ./

# ğŸ”‘ RUNï¼šæ‰§è¡Œå‘½ä»¤ï¼ˆå®‰è£…ä¾èµ–ï¼‰
RUN npm ci --prefer-offline --no-audit

# å¤åˆ¶æºä»£ç 
COPY . .

# ğŸ”‘ ENVï¼šè®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production

# ğŸ”‘ RUNï¼šæ„å»ºå‰ç«¯èµ„æº
RUN npm run build

# ============================================================================
# Stage 2: Runtime - ä½¿ç”¨ Nginx æœåŠ¡é™æ€æ–‡ä»¶
# ============================================================================
FROM nginx:1.25-alpine AS runtime

# å¤åˆ¶ Nginx é…ç½®æ–‡ä»¶
COPY nginx.conf /etc/nginx/nginx.conf

# ğŸ”‘ COPY --from=builderï¼šä» builder é˜¶æ®µå¤åˆ¶æ–‡ä»¶
COPY --from=builder /app/dist /usr/share/nginx/html

# ğŸ”‘ RUNï¼šåˆ›å»ºæ—¥å¿—ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /var/cache/nginx/client_temp \
    && chown -R nginx:nginx /var/cache/nginx \
    && chown -R nginx:nginx /usr/share/nginx/html \
    && chmod -R 755 /usr/share/nginx/html

# ğŸ”‘ USERï¼šåˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nginx

# ğŸ”‘ EXPOSEï¼šå£°æ˜æš´éœ²çš„ç«¯å£
EXPOSE 80

# ğŸ”‘ HEALTHCHECKï¼šå¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost/ || exit 1

# ğŸ”‘ CMDï¼šå®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤
CMD ["nginx", "-g", "daemon off;"]
```

**å¸¸ç”¨æŒ‡ä»¤å¯¹æ¯”è¡¨**ï¼š

| æŒ‡ä»¤ | ä½œç”¨ | æ‰§è¡Œæ—¶æœº | é¡¹ç›®ç¤ºä¾‹ |
|------|------|---------|---------|
| `FROM` | æŒ‡å®šåŸºç¡€é•œåƒ | æ„å»ºæ—¶ | `FROM python:3.11-slim-bookworm` |
| `WORKDIR` | è®¾ç½®å·¥ä½œç›®å½• | æ„å»ºæ—¶ | `WORKDIR /app` |
| `COPY` | å¤åˆ¶æ–‡ä»¶åˆ°é•œåƒ | æ„å»ºæ—¶ | `COPY package.json ./` |
| `RUN` | æ‰§è¡Œå‘½ä»¤ï¼ˆå®‰è£…ä¾èµ–ï¼‰ | æ„å»ºæ—¶ | `RUN npm install` |
| `ENV` | è®¾ç½®ç¯å¢ƒå˜é‡ | æ„å»ºæ—¶ | `ENV NODE_ENV=production` |
| `ARG` | æ„å»ºå‚æ•° | æ„å»ºæ—¶ | `ARG NODE_ENV=production` |
| `EXPOSE` | å£°æ˜ç«¯å£ | æ„å»ºæ—¶ | `EXPOSE 8000` |
| `USER` | åˆ‡æ¢ç”¨æˆ· | æ„å»ºæ—¶ | `USER appuser` |
| `CMD` | é»˜è®¤å¯åŠ¨å‘½ä»¤ | è¿è¡Œæ—¶ | `CMD ["uvicorn", "app.main:app"]` |
| `ENTRYPOINT` | å›ºå®šå¯åŠ¨å‘½ä»¤ | è¿è¡Œæ—¶ | `ENTRYPOINT ["python"]` |
| `HEALTHCHECK` | å¥åº·æ£€æŸ¥ | è¿è¡Œæ—¶ | `HEALTHCHECK CMD curl http://localhost/health` |

**å…³é”®åŒºåˆ«**ï¼š
- **RUN vs CMD**ï¼š
  - `RUN`ï¼šæ„å»ºé•œåƒæ—¶æ‰§è¡Œï¼ˆå¦‚å®‰è£…ä¾èµ–ï¼‰
  - `CMD`ï¼šå¯åŠ¨å®¹å™¨æ—¶æ‰§è¡Œï¼ˆå¦‚å¯åŠ¨åº”ç”¨ï¼‰

- **CMD vs ENTRYPOINT**ï¼š
  - `CMD`ï¼šå¯è¢« `docker run` å‚æ•°è¦†ç›–
  - `ENTRYPOINT`ï¼šä¸å¯è¦†ç›–ï¼ŒCMD æˆä¸ºå‚æ•°

---

### 3. å¤šé˜¶æ®µæ„å»ºï¼ˆMulti-Stage Buildï¼‰= æµæ°´çº¿ç”Ÿäº§

**ç±»æ¯”**ï¼šå¤šé˜¶æ®µæ„å»ºå°±åƒå·¥å‚çš„æµæ°´çº¿ï¼Œæ¯ä¸ªé˜¶æ®µè´Ÿè´£ç‰¹å®šä»»åŠ¡ï¼Œæœ€ååªä¿ç•™æˆå“ã€‚

**é¡¹ç›®å®ä¾‹åˆ†æ**ï¼ˆåç«¯é•œåƒï¼‰ï¼š

```dockerfile
# ============================================================================
# é—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦å¤šé˜¶æ®µæ„å»ºï¼Ÿ
# ============================================================================

# âŒ å•é˜¶æ®µæ„å»ºçš„é—®é¢˜ï¼š
# 1. é•œåƒä½“ç§¯å¤§ï¼šåŒ…å«ç¼–è¯‘å·¥å…·ï¼ˆgcc, g++ï¼‰ã€Poetryã€æºä»£ç ç­‰
# 2. å®‰å…¨é£é™©ï¼šä¸å¿…è¦çš„å·¥å…·å¯èƒ½è¢«æ”»å‡»è€…åˆ©ç”¨
# 3. æ„å»ºç¼“æ…¢ï¼šæ¯æ¬¡ä¿®æ”¹ä»£ç éƒ½è¦é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–

# ============================================================================
# âœ… å¤šé˜¶æ®µæ„å»ºè§£å†³æ–¹æ¡ˆ
# ============================================================================

# ç¬¬ä¸€é˜¶æ®µï¼šBuilderï¼ˆæ„å»ºç¯å¢ƒï¼‰
FROM python:3.11-slim-bookworm AS builder

# å®‰è£…ç¼–è¯‘å·¥å…·å’Œ Poetry
RUN apt-get update && apt-get install -y build-essential curl \
    && curl -sSL https://install.python-poetry.org | python3 -

# å®‰è£… Python ä¾èµ–ï¼ˆç”Ÿæˆ .venv è™šæ‹Ÿç¯å¢ƒï¼‰
COPY pyproject.toml poetry.lock ./
RUN poetry install --no-root --only main

# ğŸ”‘ å…³é”®ç‚¹ï¼šæ­¤æ—¶ .venv ç›®å½•åŒ…å«æ‰€æœ‰ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶

# ============================================================================
# ç¬¬äºŒé˜¶æ®µï¼šRuntimeï¼ˆè¿è¡Œç¯å¢ƒï¼‰
FROM python:3.11-slim-bookworm AS runtime

# ğŸ”‘ åªå¤åˆ¶è™šæ‹Ÿç¯å¢ƒï¼Œä¸å¤åˆ¶ Poetry å’Œç¼–è¯‘å·¥å…·
COPY --from=builder /app/.venv /app/.venv

# å¤åˆ¶åº”ç”¨ä»£ç ï¼ˆåªéœ€è¦æºä»£ç ï¼Œä¸éœ€è¦å¼€å‘å·¥å…·ï¼‰
COPY ./app /app/app
COPY ./alembic /app/alembic

# ğŸ”‘ ç»“æœï¼š
# - é•œåƒä½“ç§¯ï¼šä» 1.5GB å‡å°‘åˆ° 400MB
# - å®‰å…¨æ€§ï¼šç§»é™¤äº† gccã€g++ã€Poetry ç­‰å·¥å…·
# - å¯åŠ¨é€Ÿåº¦ï¼šå‡å°‘é•œåƒå±‚ï¼Œå¯åŠ¨æ›´å¿«
```

**å‰ç«¯é•œåƒçš„å¤šé˜¶æ®µæ„å»º**ï¼š

```dockerfile
# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºï¼ˆNode.js ç¼–è¯‘å™¨ï¼‰
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build
# ğŸ”‘ ç”Ÿæˆ /app/dist ç›®å½•ï¼ŒåŒ…å«ç¼–è¯‘åçš„é™æ€æ–‡ä»¶

# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œï¼ˆNginx æœåŠ¡å™¨ï¼‰
FROM nginx:1.25-alpine AS runtime
# ğŸ”‘ åªå¤åˆ¶ç¼–è¯‘åçš„é™æ€æ–‡ä»¶ï¼Œä¸å¤åˆ¶ Node.js å’Œ npm
COPY --from=builder /app/dist /usr/share/nginx/html
CMD ["nginx", "-g", "daemon off;"]

# ğŸ”‘ ç»“æœï¼š
# - é•œåƒä½“ç§¯ï¼šä» 1.2GBï¼ˆNode.jsï¼‰ å‡å°‘åˆ° 50MBï¼ˆNginxï¼‰
# - å®‰å…¨æ€§ï¼šç§»é™¤äº† Node.jsã€npmã€TypeScript ç¼–è¯‘å™¨
# - æ€§èƒ½ï¼šNginx æ¯” Node.js æ›´å¿«åœ°æœåŠ¡é™æ€æ–‡ä»¶
```

**å¤šé˜¶æ®µæ„å»ºçš„ä¼˜åŠ¿**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å•é˜¶æ®µ vs å¤šé˜¶æ®µå¯¹æ¯”                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•é˜¶æ®µæ„å»ºï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ åŸºç¡€é•œåƒï¼ˆNode.jsï¼‰                                  â”‚   â”‚
â”‚ â”‚ + npm installï¼ˆä¾èµ–åŒ…ï¼‰                              â”‚   â”‚
â”‚ â”‚ + npm run buildï¼ˆç¼–è¯‘å·¥å…·ï¼‰                          â”‚   â”‚
â”‚ â”‚ + æºä»£ç ï¼ˆ.ts æ–‡ä»¶ï¼‰                                 â”‚   â”‚
â”‚ â”‚ + ç¼–è¯‘åæ–‡ä»¶ï¼ˆ.js æ–‡ä»¶ï¼‰                             â”‚   â”‚
â”‚ â”‚ = 1.2GB é•œåƒ                                         â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚ å¤šé˜¶æ®µæ„å»ºï¼ˆç°ä»£æ–¹å¼ï¼‰                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ â”‚ Stage 1: Builder     â”‚   â”‚ Stage 2: Runtime      â”‚      â”‚
â”‚ â”‚ Node.js + npm        â”‚   â”‚ Nginx                 â”‚      â”‚
â”‚ â”‚ ç¼–è¯‘ TypeScript      â”‚â”€â”€>â”‚ åªå¤åˆ¶ç¼–è¯‘åæ–‡ä»¶       â”‚      â”‚
â”‚ â”‚ ç”Ÿæˆ /dist           â”‚   â”‚ = 50MB é•œåƒ           â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         (ä¸¢å¼ƒ)                     (ä¿ç•™)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. å®¹å™¨ç½‘ç»œï¼ˆNetworkingï¼‰= è™šæ‹Ÿå±€åŸŸç½‘

**ç±»æ¯”**ï¼šDocker ç½‘ç»œå°±åƒè™šæ‹Ÿçš„å±€åŸŸç½‘ï¼Œå®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡"å†…éƒ¨ IP"é€šä¿¡ã€‚

**é¡¹ç›®å®ä¾‹**ï¼ˆæ¥è‡ª `docker-compose.yml:183-186`ï¼‰ï¼š

```yaml
# ============================================================================
# ç½‘ç»œå®šä¹‰
# ============================================================================
networks:
  innoliber_network:
    driver: bridge  # æ¡¥æ¥æ¨¡å¼ï¼šæœ€å¸¸ç”¨çš„ç½‘ç»œæ¨¡å¼
```

**ç½‘ç»œæ¨¡å¼å¯¹æ¯”**ï¼š

| ç½‘ç»œæ¨¡å¼ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ | é¡¹ç›®ä¸­çš„åº”ç”¨ |
|---------|------|---------|-------------|
| `bridge` | æ¡¥æ¥æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ | å¤šå®¹å™¨é€šä¿¡ | âœ… æ‰€æœ‰æœåŠ¡åœ¨åŒä¸€ç½‘ç»œ |
| `host` | ä¸»æœºæ¨¡å¼ | æ€§èƒ½ä¼˜å…ˆ | âŒ ä¸æ¨èï¼ˆç«¯å£å†²çªï¼‰ |
| `none` | æ— ç½‘ç»œ | éš”ç¦»å®¹å™¨ | âŒ ä¸é€‚ç”¨ |
| `container` | å…±äº«ç½‘ç»œ | ç´§å¯†è€¦åˆ | âŒ ä¸é€‚ç”¨ |

**å®¹å™¨å¦‚ä½•é€šä¿¡ï¼Ÿ**

```yaml
# æ¥è‡ª docker-compose.yml
services:
  postgres:
    container_name: innoliber_postgres
    networks:
      - innoliber_network
    # ğŸ”‘ å†…éƒ¨åœ°å€ï¼špostgresï¼ˆæœåŠ¡åå³ä¸»æœºåï¼‰

  backend:
    depends_on:
      - postgres
    environment:
      # ğŸ”‘ ä½¿ç”¨æœåŠ¡åè¿æ¥æ•°æ®åº“
      DATABASE_URL: "postgresql+asyncpg://innoliber:password@postgres:5432/innoliber"
      #                                                        â†‘ æœåŠ¡å
    networks:
      - innoliber_network
```

**ç½‘ç»œé€šä¿¡æµç¨‹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Docker æ¡¥æ¥ç½‘ç»œï¼ˆbridgeï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  postgres    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  backend     â”‚           â”‚
â”‚  â”‚  å®¹å™¨         â”‚  å†…éƒ¨é€šä¿¡  â”‚  å®¹å™¨         â”‚           â”‚
â”‚  â”‚  (5432)      â”‚          â”‚  (8000)      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â†‘                          â†‘                     â”‚
â”‚       â”‚ å†…éƒ¨DNSè§£æ              â”‚                     â”‚
â”‚       â”‚ postgres â†’ 172.18.0.2   â”‚                     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  redis       â”‚          â”‚  frontend    â”‚           â”‚
â”‚  â”‚  å®¹å™¨         â”‚          â”‚  å®¹å™¨         â”‚           â”‚
â”‚  â”‚  (6379)      â”‚          â”‚  (80)        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
              å®¿ä¸»æœºç½‘ç»œï¼ˆç«¯å£æ˜ å°„ï¼‰
              - postgres:5432 â†’ localhost:5432
              - backend:8000 â†’ localhost:8000
              - frontend:80 â†’ localhost:3000
```

---

### 5. æ•°æ®å·ï¼ˆVolumesï¼‰= æŒä¹…åŒ–å­˜å‚¨

**ç±»æ¯”**ï¼šæ•°æ®å·å°±åƒå¤–æ¥ç¡¬ç›˜ï¼Œå®¹å™¨åˆ é™¤åæ•°æ®ä»ç„¶ä¿ç•™ã€‚

**é—®é¢˜åœºæ™¯**ï¼š
```bash
# âŒ æ²¡æœ‰æ•°æ®å·çš„é—®é¢˜
docker run postgres
# åˆ›å»ºæ•°æ®åº“ï¼Œæ’å…¥æ•°æ®...
docker stop postgres
docker rm postgres
# ğŸš¨ é—®é¢˜ï¼šæ•°æ®ä¸¢å¤±ï¼å®¹å™¨åˆ é™¤åæ•°æ®ä¹Ÿåˆ é™¤

# âœ… ä½¿ç”¨æ•°æ®å·çš„è§£å†³æ–¹æ¡ˆ
docker run -v postgres_data:/var/lib/postgresql/data postgres
# åˆ›å»ºæ•°æ®åº“ï¼Œæ’å…¥æ•°æ®...
docker stop postgres
docker rm postgres
docker run -v postgres_data:/var/lib/postgresql/data postgres
# âœ… æ•°æ®ä¿ç•™ï¼æ–°å®¹å™¨è‡ªåŠ¨æŒ‚è½½æ—§æ•°æ®
```

**é¡¹ç›®å®ä¾‹**ï¼ˆæ¥è‡ª `docker-compose.yml:173-181`ï¼‰ï¼š

```yaml
# ============================================================================
# æ•°æ®å·å®šä¹‰
# ============================================================================
volumes:
  # ğŸ”‘ PostgreSQL æ•°æ®æŒä¹…åŒ–
  postgres_data:
    driver: local  # å­˜å‚¨åœ¨å®¿ä¸»æœºæœ¬åœ°ç£ç›˜

  # ğŸ”‘ Redis æ•°æ®æŒä¹…åŒ–
  redis_data:
    driver: local

  # ğŸ”‘ pgAdmin é…ç½®æŒä¹…åŒ–
  pgadmin_data:
    driver: local

# ============================================================================
# æœåŠ¡ä¸­ä½¿ç”¨æ•°æ®å·
# ============================================================================
services:
  postgres:
    image: pgvector/pgvector:pg16
    volumes:
      # ğŸ”‘ æ ¼å¼ï¼švolume_name:container_path
      - postgres_data:/var/lib/postgresql/data
      # è¯´æ˜ï¼š
      # - postgres_dataï¼šå·åç§°ï¼ˆDocker ç®¡ç†çš„å­˜å‚¨ï¼‰
      # - /var/lib/postgresql/dataï¼šå®¹å™¨å†…è·¯å¾„ï¼ˆPostgreSQL æ•°æ®ç›®å½•ï¼‰

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data  # Redis æ•°æ®ç›®å½•
```

**æ•°æ®å·ç±»å‹å¯¹æ¯”**ï¼š

| ç±»å‹ | è¯­æ³• | ç‰¹ç‚¹ | ä½¿ç”¨åœºæ™¯ | é¡¹ç›®ç¤ºä¾‹ |
|------|------|------|---------|---------|
| **å‘½åå·** | `volume_name:/path` | Docker ç®¡ç†ï¼ŒæŒä¹…åŒ– | âœ… ç”Ÿäº§æ•°æ® | `postgres_data:/var/lib/postgresql/data` |
| **ç»‘å®šæŒ‚è½½** | `./host/path:/container/path` | å®¿ä¸»æœºç›®å½•æ˜ å°„ | âœ… å¼€å‘ä»£ç  | `./backend/app:/app/app:ro` |
| **åŒ¿åå·** | `/container/path` | ä¸´æ—¶å­˜å‚¨ | âŒ ä¸æ¨è | - |

**æ•°æ®å·çš„å®é™…åº”ç”¨**ï¼š

```yaml
# æ¥è‡ª docker-compose.yml
services:
  backend:
    build: ./backend
    volumes:
      # ğŸ”‘ å¼€å‘æ¨¡å¼ï¼šç»‘å®šæŒ‚è½½ï¼ˆä»£ç çƒ­é‡è½½ï¼‰
      - ./backend/app:/app/app:ro  # ro = read-onlyï¼ˆåªè¯»ï¼‰
      # è¯´æ˜ï¼š
      # - æœ¬åœ°ä¿®æ”¹ä»£ç  â†’ å®¹å™¨å†…ç«‹å³æ›´æ–°
      # - ro æ ‡è®°ï¼šé˜²æ­¢å®¹å™¨å†…ä¿®æ”¹å½±å“æœ¬åœ°ä»£ç 

  postgres:
    image: pgvector/pgvector:pg16
    volumes:
      # ğŸ”‘ ç”Ÿäº§æ¨¡å¼ï¼šå‘½åå·ï¼ˆæ•°æ®æŒä¹…åŒ–ï¼‰
      - postgres_data:/var/lib/postgresql/data
      # è¯´æ˜ï¼š
      # - Docker ç®¡ç†å­˜å‚¨ä½ç½®ï¼ˆé€šå¸¸åœ¨ /var/lib/docker/volumes/ï¼‰
      # - å®¹å™¨åˆ é™¤åæ•°æ®ä¿ç•™
      # - å¯ä»¥å¤‡ä»½å’Œè¿ç§»
```

**æ•°æ®å·çš„ç”Ÿå‘½å‘¨æœŸ**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®å·ç”Ÿå‘½å‘¨æœŸ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  1. åˆ›å»ºå·                                           â”‚
â”‚     docker volume create postgres_data              â”‚
â”‚     â””â”€> åœ¨å®¿ä¸»æœºåˆ›å»ºå­˜å‚¨ç©ºé—´                         â”‚
â”‚                                                       â”‚
â”‚  2. æŒ‚è½½åˆ°å®¹å™¨                                       â”‚
â”‚     docker run -v postgres_data:/data postgres      â”‚
â”‚     â””â”€> å®¹å™¨å¯ä»¥è¯»å†™å·ä¸­çš„æ•°æ®                       â”‚
â”‚                                                       â”‚
â”‚  3. å®¹å™¨ç”Ÿå‘½å‘¨æœŸ                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚ å®¹å™¨å¯åŠ¨ â†’ ä½¿ç”¨å· â†’ å®¹å™¨åœæ­¢       â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚              â†“         â†“                              â”‚
â”‚          æ•°æ®å†™å…¥    æ•°æ®ä¿ç•™                         â”‚
â”‚                                                       â”‚
â”‚  4. å®¹å™¨åˆ é™¤                                         â”‚
â”‚     docker rm postgres                               â”‚
â”‚     â””â”€> å®¹å™¨åˆ é™¤ï¼Œä½†å·ä¿ç•™ï¼                         â”‚
â”‚                                                       â”‚
â”‚  5. å·åˆ é™¤                                           â”‚
â”‚     docker volume rm postgres_data                   â”‚
â”‚     â””â”€> æ˜¾å¼åˆ é™¤å·åï¼Œæ•°æ®æ‰çœŸæ­£åˆ é™¤                 â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6. å¥åº·æ£€æŸ¥ï¼ˆHealth Checkï¼‰= è‡ªåŠ¨ä½“æ£€

**ç±»æ¯”**ï¼šå¥åº·æ£€æŸ¥å°±åƒå®šæœŸä½“æ£€ï¼Œè‡ªåŠ¨æ£€æµ‹å®¹å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

**é¡¹ç›®å®ä¾‹**ï¼ˆæ¥è‡ª `backend/Dockerfile:79-81`ï¼‰ï¼š

```dockerfile
# ============================================================================
# å¥åº·æ£€æŸ¥é…ç½®
# ============================================================================
HEALTHCHECK --interval=30s \       # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
            --timeout=10s \        # è¶…æ—¶æ—¶é—´10ç§’
            --start-period=5s \    # å¯åŠ¨åç­‰å¾…5ç§’å†æ£€æŸ¥
            --retries=3 \          # å¤±è´¥3æ¬¡æ‰æ ‡è®°ä¸ºä¸å¥åº·
    CMD python -c "import requests; requests.get('http://localhost:8000/health', timeout=2)"
    # ğŸ”‘ æ£€æŸ¥æ–¹æ³•ï¼šè°ƒç”¨ /health ç«¯ç‚¹ï¼Œç¡®ä¿åº”ç”¨å“åº”
```

**å¥åº·æ£€æŸ¥çŠ¶æ€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å®¹å™¨å¥åº·çŠ¶æ€å˜åŒ–                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  starting (å¯åŠ¨ä¸­)                                   â”‚
â”‚     â†“                                                 â”‚
â”‚     â””â”€> ç­‰å¾… start-period (5ç§’)                     â”‚
â”‚                                                       â”‚
â”‚  healthy (å¥åº·)                                      â”‚
â”‚     â†“                                                 â”‚
â”‚     â””â”€> æ¯ interval (30ç§’) æ‰§è¡Œæ£€æŸ¥                 â”‚
â”‚         â”œâ”€> æˆåŠŸ â†’ ä¿æŒ healthy                     â”‚
â”‚         â””â”€> å¤±è´¥ â†’ è¿›å…¥ unhealthy                    â”‚
â”‚                                                       â”‚
â”‚  unhealthy (ä¸å¥åº·)                                  â”‚
â”‚     â†“                                                 â”‚
â”‚     â””â”€> è§¦å‘ retries (3æ¬¡)                           â”‚
â”‚         â”œâ”€> æ¢å¤ â†’ å›åˆ° healthy                      â”‚
â”‚         â””â”€> æŒç»­å¤±è´¥ â†’ å®¹å™¨é‡å¯ï¼ˆå¦‚é…ç½®ï¼‰            â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‰ç«¯å¥åº·æ£€æŸ¥**ï¼ˆæ¥è‡ª `frontend/Dockerfile:57-59`ï¼‰ï¼š

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost/ || exit 1
    # ğŸ”‘ ä½¿ç”¨ wget æ£€æŸ¥ Nginx é¦–é¡µæ˜¯å¦å“åº”
```

**ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥ï¼Ÿ**
- âœ… **è‡ªåŠ¨æ¢å¤**ï¼šä¸å¥åº·çš„å®¹å™¨è‡ªåŠ¨é‡å¯
- âœ… **è´Ÿè½½å‡è¡¡**ï¼šä¸å¥åº·çš„å®¹å™¨ä»è´Ÿè½½å‡è¡¡æ± ä¸­ç§»é™¤
- âœ… **ç›‘æ§å‘Šè­¦**ï¼šå¥åº·çŠ¶æ€å¯ä»¥è¢«ç›‘æ§ç³»ç»Ÿé‡‡é›†
- âœ… **æ»šåŠ¨æ›´æ–°**ï¼šéƒ¨ç½²æ—¶ç¡®ä¿æ–°å®¹å™¨å¥åº·åæ‰æ›¿æ¢æ—§å®¹å™¨

---

### 7. ç¯å¢ƒå˜é‡ï¼ˆEnvironment Variablesï¼‰= é…ç½®å¼€å…³

**ç±»æ¯”**ï¼šç¯å¢ƒå˜é‡å°±åƒé¥æ§å™¨çš„æŒ‰é’®ï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹è°ƒæ•´å®¹å™¨è¡Œä¸ºã€‚

**é¡¹ç›®å®ä¾‹**ï¼ˆæ¥è‡ª `docker-compose.yml:18-33`ï¼‰ï¼š

```yaml
# ============================================================================
# PostgreSQL å®¹å™¨ç¯å¢ƒå˜é‡
# ============================================================================
services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: innoliber_postgres
    environment:
      # ğŸ”‘ æ•°æ®åº“é…ç½®
      POSTGRES_USER: ${POSTGRES_USER:-innoliber}         # é»˜è®¤å€¼ï¼šinnoliber
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}  # é»˜è®¤å€¼ï¼špassword
      POSTGRES_DB: ${POSTGRES_DB:-innoliber}             # é»˜è®¤å€¼ï¼šinnoliber

      # ğŸ”‘ PostgreSQL æ€§èƒ½è°ƒä¼˜
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
```

**åç«¯å®¹å™¨ç¯å¢ƒå˜é‡**ï¼ˆæ¥è‡ª `docker-compose.yml:59-75`ï¼‰ï¼š

```yaml
services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: innoliber_backend
    environment:
      # ğŸ”‘ æ•°æ®åº“è¿æ¥ï¼ˆä½¿ç”¨æœåŠ¡åï¼‰
      DATABASE_URL: "postgresql+asyncpg://${POSTGRES_USER:-innoliber}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-innoliber}"

      # ğŸ”‘ Redis è¿æ¥
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0

      # ğŸ”‘ JWT è®¤è¯é…ç½®
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 1440

      # ğŸ”‘ åº”ç”¨é…ç½®
      PROJECT_NAME: InnoLiber
      VERSION: 0.1.0
      ENVIRONMENT: ${ENVIRONMENT:-development}
```

**ç¯å¢ƒå˜é‡çš„ä¸‰ç§è®¾ç½®æ–¹å¼**ï¼š

```yaml
# æ–¹å¼1ï¼šç›´æ¥è®¾ç½®
environment:
  NODE_ENV: production

# æ–¹å¼2ï¼šä»å®¿ä¸»æœºç¯å¢ƒå˜é‡è¯»å–
environment:
  DATABASE_URL: ${DATABASE_URL}  # å¿…é¡»åœ¨å®¿ä¸»æœºè®¾ç½®

# æ–¹å¼3ï¼šå¸¦é»˜è®¤å€¼
environment:
  REDIS_HOST: ${REDIS_HOST:-redis}  # å¦‚æœæœªè®¾ç½®ï¼Œä½¿ç”¨ redis
```

**ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆ.envï¼‰**ï¼š

```bash
# .env æ–‡ä»¶ç¤ºä¾‹
POSTGRES_USER=innoliber
POSTGRES_PASSWORD=secure_password_123
POSTGRES_DB=innoliber
JWT_SECRET_KEY=super_secret_key_for_jwt
ENVIRONMENT=production
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
# Docker Compose è‡ªåŠ¨è¯»å– .env æ–‡ä»¶
docker-compose up -d

# æˆ–æ‰‹åŠ¨æŒ‡å®šç¯å¢ƒå˜é‡æ–‡ä»¶
docker-compose --env-file .env.production up -d
```

---

## ğŸ’» é¡¹ç›®ä¸­çš„å®é™…åº”ç”¨

### ç¤ºä¾‹ 1ï¼šåç«¯å¤šé˜¶æ®µæ„å»ºæ·±åº¦è§£æ

**æ–‡ä»¶ä½ç½®**ï¼š`backend/Dockerfile`ï¼ˆå®Œæ•´è§£æï¼‰

```dockerfile
# ============================================================================
# åç«¯ Dockerfile å®Œæ•´è§£æ
# ============================================================================

# ============================================================================
# Stage 1: Builder - ä¾èµ–å®‰è£…é˜¶æ®µ
# ============================================================================
FROM python:3.11-slim-bookworm AS builder

# ğŸ“‹ è®¾è®¡å†³ç­–ï¼šä¸ºä»€ä¹ˆé€‰æ‹© slim-bookwormï¼Ÿ
# - slimï¼šç›¸æ¯”å®Œæ•´é•œåƒå‡å°‘ 50% ä½“ç§¯ï¼ˆçº¦ 120MB vs 900MBï¼‰
# - bookwormï¼šDebian 12ï¼Œæœ€æ–°ç¨³å®šç‰ˆ
# - æ’é™¤ alpineï¼šPyTorch ç­‰ç§‘å­¦è®¡ç®—åº“åœ¨ Alpine ä¸‹ç¼–è¯‘å›°éš¾

WORKDIR /app

# ğŸ”‘ Poetry é…ç½®ï¼ˆä¾èµ–ç®¡ç†å·¥å…·ï¼‰
ENV POETRY_VERSION=1.7.1 \
    POETRY_HOME="/opt/poetry" \
    POETRY_VIRTUALENVS_IN_PROJECT=1 \     # è™šæ‹Ÿç¯å¢ƒåœ¨é¡¹ç›®å†…ï¼ˆ.venv/ï¼‰
    POETRY_NO_INTERACTION=1               # éäº¤äº’æ¨¡å¼ï¼ˆCI/CD å‹å¥½ï¼‰

# ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
# build-essential: gcc, g++ï¼ˆç¼–è¯‘ Python C æ‰©å±•ï¼‰
# curl: ä¸‹è½½ Poetry å®‰è£…è„šæœ¬
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*        # æ¸…ç†ç¼“å­˜ï¼Œå‡å°‘é•œåƒä½“ç§¯

# ğŸ”§ å®‰è£… Poetry
RUN curl -sSL https://install.python-poetry.org | python3 - \
    && ln -s ${POETRY_HOME}/bin/poetry /usr/local/bin/poetry

# ğŸ“„ å¤åˆ¶ä¾èµ–é…ç½®æ–‡ä»¶ï¼ˆåˆ©ç”¨ Docker ç¼“å­˜ï¼‰
# ğŸ”‘ æŠ€å·§ï¼šåªå¤åˆ¶ pyproject.toml å’Œ poetry.lockï¼Œä¸å¤åˆ¶æºä»£ç 
# å¥½å¤„ï¼šæºä»£ç ä¿®æ”¹ä¸ä¼šå¯¼è‡´é‡æ–°å®‰è£…ä¾èµ–
COPY pyproject.toml poetry.lock ./

# ğŸ“¦ å®‰è£… Python ä¾èµ–
# --no-root: ä¸å®‰è£…é¡¹ç›®æœ¬èº«ï¼ˆåªå®‰è£…ä¾èµ–ï¼‰
# --only main: åªå®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆä¸å®‰è£… dev ä¾èµ–ï¼‰
RUN poetry install --no-root --only main

# ğŸ¯ ç»“æœï¼š.venv ç›®å½•åŒ…å«æ‰€æœ‰ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶

# ============================================================================
# Stage 2: Runtime - è¿è¡Œç¯å¢ƒ
# ============================================================================
FROM python:3.11-slim-bookworm AS runtime

# ğŸ“‹ è®¾è®¡å†³ç­–ï¼šä¸ºä»€ä¹ˆéœ€è¦ç¬¬äºŒé˜¶æ®µï¼Ÿ
# - ç§»é™¤ç¼–è¯‘å·¥å…·ï¼ˆgcc, g++ï¼‰ï¼šå‡å°‘æ”»å‡»é¢
# - ç§»é™¤ Poetryï¼šç”Ÿäº§ç¯å¢ƒä¸éœ€è¦
# - åªä¿ç•™å¿…è¦çš„è¿è¡Œæ—¶ä¾èµ–

WORKDIR /app

# ğŸ”’ å®‰å…¨å®è·µï¼šåˆ›å»ºé root ç”¨æˆ·
# -m: åˆ›å»ºå®¶ç›®å½•
# -u 1000: æŒ‡å®š UIDï¼ˆä¸å¸¸è§ Linux ç”¨æˆ· UID ä¸€è‡´ï¼‰
RUN useradd -m -u 1000 appuser

# ğŸ”‘ å¤åˆ¶è™šæ‹Ÿç¯å¢ƒï¼ˆä» builder é˜¶æ®µï¼‰
ENV VIRTUAL_ENV=/app/.venv \
    PATH="/app/.venv/bin:$PATH"           # å°†è™šæ‹Ÿç¯å¢ƒçš„ bin åŠ å…¥ PATH

COPY --from=builder --chown=appuser:appuser ${VIRTUAL_ENV} ${VIRTUAL_ENV}
# --chown=appuser:appuser: è®¾ç½®æ–‡ä»¶æ‰€æœ‰è€…ä¸º appuser

# ğŸ“ å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=appuser:appuser ./app /app/app
COPY --chown=appuser:appuser ./alembic /app/alembic
COPY --chown=appuser:appuser ./alembic.ini /app/alembic.ini

# ğŸ”’ åˆ‡æ¢åˆ°é root ç”¨æˆ·
# åŸå› ï¼šroot ç”¨æˆ·è¿è¡Œå®¹å™¨æ˜¯å®‰å…¨éšæ‚£
USER appuser

# ğŸ“¡ æš´éœ²ç«¯å£ï¼ˆæ–‡æ¡£ä½œç”¨ï¼Œä¸å®é™…å¼€æ”¾ï¼‰
EXPOSE 8000

# ğŸ¥ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health', timeout=2)"
# è¯´æ˜ï¼š
# - interval=30s: æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡
# - timeout=10s: æ£€æŸ¥å‘½ä»¤è¶…æ—¶æ—¶é—´
# - start-period=5s: å®¹å™¨å¯åŠ¨åç­‰å¾… 5 ç§’å†å¼€å§‹æ£€æŸ¥
# - retries=3: è¿ç»­å¤±è´¥ 3 æ¬¡æ‰æ ‡è®°ä¸ºä¸å¥åº·

# ğŸš€ å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--proxy-headers"]
# è¯´æ˜ï¼š
# - uvicorn: ASGI æœåŠ¡å™¨
# - app.main:app: åº”ç”¨å…¥å£ï¼ˆapp/main.py ä¸­çš„ app å¯¹è±¡ï¼‰
# - --host 0.0.0.0: ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£ï¼ˆå®¹å™¨å†…å¿…éœ€ï¼‰
# - --port 8000: ç›‘å¬ç«¯å£
# - --proxy-headers: ä¿¡ä»»ä»£ç†å¤´ï¼ˆç”¨äº Nginx åå‘ä»£ç†ï¼‰
```

**æ„å»ºå’Œè¿è¡Œå‘½ä»¤**ï¼š

```bash
# æ„å»ºé•œåƒ
docker build -t innoliber-backend:latest ./backend

# è¿è¡Œå®¹å™¨
docker run -d \
  --name backend \
  -p 8000:8000 \
  -e DATABASE_URL="postgresql+asyncpg://user:pass@postgres:5432/db" \
  innoliber-backend:latest

# æŸ¥çœ‹æ—¥å¿—
docker logs -f backend

# æŸ¥çœ‹å¥åº·çŠ¶æ€
docker inspect --format='{{.State.Health.Status}}' backend
```

---

### ç¤ºä¾‹ 2ï¼šå‰ç«¯ Nginx é…ç½®å’Œé•œåƒä¼˜åŒ–

**æ–‡ä»¶ä½ç½®**ï¼š`frontend/Dockerfile`ï¼ˆå®Œæ•´è§£æï¼‰

```dockerfile
# ============================================================================
# å‰ç«¯ Dockerfile å®Œæ•´è§£æ
# ============================================================================

# ============================================================================
# Stage 1: Builder - å‰ç«¯èµ„æºæ„å»º
# ============================================================================
FROM node:20-alpine AS builder

# ğŸ“‹ è®¾è®¡å†³ç­–ï¼šä¸ºä»€ä¹ˆé€‰æ‹© Alpineï¼Ÿ
# - ä½“ç§¯å°ï¼š5MB vs 900MBï¼ˆå®Œæ•´ Node.js é•œåƒï¼‰
# - å®‰å…¨ï¼šæœ€å°åŒ–æ”»å‡»é¢
# - å‰ç«¯æ„å»ºï¼šä¸éœ€è¦å¤æ‚çš„ç³»ç»Ÿä¾èµ–

# ğŸ”§ æ„å»ºå‚æ•°ï¼ˆå¯åœ¨æ„å»ºæ—¶ä¼ å…¥ï¼‰
ARG NODE_ENV=production

WORKDIR /app

# ğŸ“„ å¤åˆ¶ package.json å’Œ package-lock.json
COPY package*.json ./

# ğŸ“¦ å®‰è£…ä¾èµ–
# npm ci: ç±»ä¼¼ npm installï¼Œä½†æ›´é€‚åˆ CI/CD
# --prefer-offline: ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜
# --no-audit: è·³è¿‡å®‰å…¨å®¡è®¡ï¼ˆåŠ å¿«æ„å»ºé€Ÿåº¦ï¼‰
RUN npm ci --prefer-offline --no-audit

# ğŸ“ å¤åˆ¶æºä»£ç 
COPY . .

# ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production

# ğŸ—ï¸ æ„å»ºå‰ç«¯èµ„æº
# Vite ä¼šç”Ÿæˆ /app/dist ç›®å½•
RUN npm run build

# ğŸ¯ ç»“æœï¼š/app/dist ç›®å½•åŒ…å«ç¼–è¯‘åçš„é™æ€æ–‡ä»¶

# ============================================================================
# Stage 2: Runtime - Nginx æœåŠ¡é™æ€æ–‡ä»¶
# ============================================================================
FROM nginx:1.25-alpine AS runtime

# ğŸ“‹ è®¾è®¡å†³ç­–ï¼šä¸ºä»€ä¹ˆä½¿ç”¨ Nginxï¼Ÿ
# - æ€§èƒ½ï¼šNginx æœåŠ¡é™æ€æ–‡ä»¶æ¯” Node.js å¿« 10 å€
# - ç¨³å®šï¼šNginx å¤„ç†å¹¶å‘è¿æ¥èƒ½åŠ›å¼º
# - ä½“ç§¯ï¼šNginx Alpine é•œåƒä»… 40MB

# ğŸ“„ å¤åˆ¶ Nginx é…ç½®æ–‡ä»¶
COPY nginx.conf /etc/nginx/nginx.conf

# ğŸ”‘ å¤åˆ¶å‰ç«¯èµ„æºï¼ˆä» builder é˜¶æ®µï¼‰
COPY --from=builder /app/dist /usr/share/nginx/html
# è¯´æ˜ï¼šåªå¤åˆ¶ç¼–è¯‘åçš„é™æ€æ–‡ä»¶ï¼Œä¸å¤åˆ¶ Node.js å’Œ npm

# ğŸ”§ åˆ›å»ºå¿…è¦çš„ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /var/cache/nginx/client_temp \
    && chown -R nginx:nginx /var/cache/nginx \
    && chown -R nginx:nginx /usr/share/nginx/html \
    && chmod -R 755 /usr/share/nginx/html

# ğŸ”’ åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nginx

# ğŸ“¡ æš´éœ²ç«¯å£
EXPOSE 80

# ğŸ¥ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost/ || exit 1
# è¯´æ˜ï¼šä½¿ç”¨ wget æ£€æŸ¥ Nginx é¦–é¡µæ˜¯å¦å“åº”

# ğŸš€ å¯åŠ¨å‘½ä»¤
CMD ["nginx", "-g", "daemon off;"]
# è¯´æ˜ï¼š
# - nginx: å¯åŠ¨ Nginx
# - -g "daemon off;": å‰å°è¿è¡Œï¼ˆå®¹å™¨éœ€è¦å‰å°è¿›ç¨‹ï¼‰
```

**Nginx é…ç½®æ–‡ä»¶è§£æ**ï¼ˆ`frontend/nginx.conf`ï¼‰ï¼š

```nginx
# ============================================================================
# Nginx é…ç½®æ–‡ä»¶ï¼ˆç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ï¼‰
# ============================================================================

user nginx;
worker_processes auto;              # ğŸ”‘ è‡ªåŠ¨è®¾ç½®å·¥ä½œè¿›ç¨‹æ•°ï¼ˆç­‰äº CPU æ ¸å¿ƒæ•°ï¼‰
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;        # ğŸ”‘ æ¯ä¸ªå·¥ä½œè¿›ç¨‹æœ€å¤§è¿æ¥æ•°
    use epoll;                       # ğŸ”‘ Linux é«˜æ•ˆ I/O æ¨¡å‹
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ğŸ”‘ æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # ğŸ”‘ æ€§èƒ½ä¼˜åŒ–
    sendfile on;                     # é›¶æ‹·è´æ–‡ä»¶ä¼ è¾“
    tcp_nopush on;                   # TCP ä¼˜åŒ–
    tcp_nodelay on;                  # ç¦ç”¨ Nagle ç®—æ³•
    keepalive_timeout 65;            # ä¿æŒè¿æ¥æ—¶é—´

    # ğŸ”‘ Gzip å‹ç¼©ï¼ˆå‡å°‘ä¼ è¾“ä½“ç§¯ï¼‰
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;               # å‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼‰
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html;

        # ğŸ”‘ SPA è·¯ç”±æ”¯æŒï¼ˆReact Routerï¼‰
        location / {
            try_files $uri $uri/ /index.html;
            # è¯´æ˜ï¼š
            # - å…ˆå°è¯•æ–‡ä»¶ $uri
            # - å†å°è¯•ç›®å½• $uri/
            # - æœ€åå›é€€åˆ° /index.htmlï¼ˆSPA å…¥å£ï¼‰
        }

        # ğŸ”‘ é™æ€èµ„æºç¼“å­˜
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
            expires 1y;                # ç¼“å­˜ 1 å¹´
            add_header Cache-Control "public, immutable";
        }

        # ğŸ”‘ API ä»£ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
        location /api {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ğŸ”‘ å¥åº·æ£€æŸ¥ç«¯ç‚¹
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

---

### ç¤ºä¾‹ 3ï¼šDocker Compose å¤šæœåŠ¡ç¼–æ’

**æ–‡ä»¶ä½ç½®**ï¼š`docker-compose.yml`ï¼ˆå®Œæ•´è§£æï¼‰

```yaml
# ============================================================================
# Docker Compose é…ç½®æ–‡ä»¶ - 6 æœåŠ¡ç¼–æ’
# ============================================================================

# ğŸ“‹ ç‰ˆæœ¬å£°æ˜ï¼ˆDocker Compose æ–‡ä»¶æ ¼å¼ç‰ˆæœ¬ï¼‰
version: '3.8'

# ============================================================================
# æœåŠ¡å®šä¹‰
# ============================================================================
services:
  # --------------------------------------------------------------------------
  # Service 1: PostgreSQL æ•°æ®åº“ï¼ˆå¸¦ pgvector æ‰©å±•ï¼‰
  # --------------------------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg16        # ğŸ”‘ PostgreSQL 16 + pgvector
    container_name: innoliber_postgres
    restart: unless-stopped               # ğŸ”‘ è‡ªåŠ¨é‡å¯ç­–ç•¥
    ports:
      - "${POSTGRES_PORT:-5432}:5432"    # ç«¯å£æ˜ å°„ï¼ˆé»˜è®¤ 5432ï¼‰
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-innoliber}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-innoliber}
      # ğŸ”‘ æ€§èƒ½è°ƒä¼˜å‚æ•°
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data    # ğŸ”‘ æ•°æ®æŒä¹…åŒ–
    networks:
      - innoliber_network
    # ğŸ”‘ å¥åº·æ£€æŸ¥ï¼ˆpg_isready å‘½ä»¤ï¼‰
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-innoliber}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # --------------------------------------------------------------------------
  # Service 2: Redis ç¼“å­˜
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: innoliber_redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data                 # ğŸ”‘ Redis æ•°æ®æŒä¹…åŒ–
    networks:
      - innoliber_network
    # ğŸ”‘ å¥åº·æ£€æŸ¥ï¼ˆredis-cli pingï¼‰
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------------------------
  # Service 3: FastAPI åç«¯
  # --------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: innoliber_backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    # ğŸ”‘ ä¾èµ–å…³ç³»ï¼šç­‰å¾… postgres å’Œ redis å¥åº·åæ‰å¯åŠ¨
    depends_on:
      postgres:
        condition: service_healthy       # ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡
      redis:
        condition: service_healthy
    environment:
      # ğŸ”‘ æ•°æ®åº“è¿æ¥ï¼ˆä½¿ç”¨æœåŠ¡å postgresï¼‰
      DATABASE_URL: "postgresql+asyncpg://${POSTGRES_USER:-innoliber}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-innoliber}"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-secret-key-change-in-production}
      ENVIRONMENT: ${ENVIRONMENT:-development}
    volumes:
      # ğŸ”‘ å¼€å‘æ¨¡å¼ï¼šç»‘å®šæŒ‚è½½ä»£ç ï¼ˆçƒ­é‡è½½ï¼‰
      - ./backend/app:/app/app:ro        # ro = read-only
    networks:
      - innoliber_network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=2)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # --------------------------------------------------------------------------
  # Service 4: Celery Workerï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
  # --------------------------------------------------------------------------
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: innoliber_celery_worker
    restart: unless-stopped
    # ğŸ”‘ è¦†ç›–é»˜è®¤å¯åŠ¨å‘½ä»¤
    command: celery -A app.core.celery_app worker --loglevel=info
    depends_on:
      - postgres
      - redis
      - backend
    environment:
      DATABASE_URL: "postgresql+asyncpg://${POSTGRES_USER:-innoliber}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-innoliber}"
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - ./backend/app:/app/app:ro
    networks:
      - innoliber_network

  # --------------------------------------------------------------------------
  # Service 5: React å‰ç«¯
  # --------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: innoliber_frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"      # Nginx é»˜è®¤ç«¯å£ 80
    depends_on:
      - backend
    networks:
      - innoliber_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  # --------------------------------------------------------------------------
  # Service 6: pgAdminï¼ˆæ•°æ®åº“ç®¡ç†å·¥å…·ï¼‰
  # --------------------------------------------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: innoliber_pgadmin
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@innoliber.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - innoliber_network
    depends_on:
      - postgres

# ============================================================================
# æ•°æ®å·å®šä¹‰
# ============================================================================
volumes:
  postgres_data:
    driver: local                        # æœ¬åœ°å­˜å‚¨é©±åŠ¨
  redis_data:
    driver: local
  pgadmin_data:
    driver: local

# ============================================================================
# ç½‘ç»œå®šä¹‰
# ============================================================================
networks:
  innoliber_network:
    driver: bridge                       # æ¡¥æ¥ç½‘ç»œæ¨¡å¼
    # ğŸ”‘ è¯´æ˜ï¼š
    # - æ‰€æœ‰æœåŠ¡åœ¨åŒä¸€ç½‘ç»œä¸­
    # - å¯ä»¥é€šè¿‡æœåŠ¡åäº’ç›¸è®¿é—®
    # - ä¾‹å¦‚ï¼šbackend è®¿é—® postgres:5432
```

**å¯åŠ¨å’Œç®¡ç†å‘½ä»¤**ï¼š

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend
docker-compose logs -f postgres

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·ï¼ˆå±é™©æ“ä½œï¼ï¼‰
docker-compose down -v

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart backend

# è¿›å…¥å®¹å™¨ Shell
docker-compose exec backend bash
docker-compose exec postgres psql -U innoliber
```

---

## ğŸ¯ å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

### Step 1ï¼šå®‰è£… Docker

**Windows å®‰è£…**ï¼š
```bash
# 1. ä¸‹è½½ Docker Desktop for Windows
https://www.docker.com/products/docker-desktop

# 2. å®‰è£…å¹¶å¯åŠ¨ Docker Desktop

# 3. éªŒè¯å®‰è£…
docker --version
# Output: Docker version 24.0.7, build afdd53b

docker-compose --version
# Output: Docker Compose version v2.23.0
```

**macOS å®‰è£…**ï¼š
```bash
# 1. ä¸‹è½½ Docker Desktop for Mac
https://www.docker.com/products/docker-desktop

# 2. å®‰è£…å¹¶å¯åŠ¨ Docker Desktop

# 3. éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

**Linuxï¼ˆUbuntuï¼‰å®‰è£…**ï¼š
```bash
# 1. å¸è½½æ—§ç‰ˆæœ¬
sudo apt-get remove docker docker-engine docker.io containerd runc

# 2. å®‰è£…ä¾èµ–
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg

# 3. æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 4. æ·»åŠ  Docker ä»“åº“
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 5. å®‰è£… Docker Engine
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 6. å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç»„ï¼ˆé¿å… sudoï¼‰
sudo usermod -aG docker $USER
newgrp docker

# 7. éªŒè¯å®‰è£…
docker --version
docker compose version
```

---

### Step 2ï¼šæ„å»ºç¬¬ä¸€ä¸ªé•œåƒ

**åˆ›å»ºç®€å•çš„ Dockerfile**ï¼š

```dockerfile
# ä¿å­˜ä¸º Dockerfile
FROM python:3.11-slim

WORKDIR /app

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY app.py .

# å®‰è£…ä¾èµ–
RUN pip install fastapi uvicorn

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
```

**åˆ›å»ºåº”ç”¨ä»£ç **ï¼ˆ`app.py`ï¼‰ï¼š

```python
# app.py
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def read_root():
    return {"message": "Hello from Docker!"}

@app.get("/health")
def health_check():
    return {"status": "healthy"}
```

**æ„å»ºå’Œè¿è¡Œ**ï¼š

```bash
# 1. æ„å»ºé•œåƒ
docker build -t my-first-app .

# 2. æŸ¥çœ‹é•œåƒ
docker images
# Output:
# REPOSITORY       TAG       IMAGE ID       SIZE
# my-first-app     latest    abc123def456   200MB

# 3. è¿è¡Œå®¹å™¨
docker run -d -p 8000:8000 --name my-app my-first-app

# 4. æµ‹è¯•åº”ç”¨
curl http://localhost:8000/
# Output: {"message":"Hello from Docker!"}

# 5. æŸ¥çœ‹æ—¥å¿—
docker logs my-app

# 6. åœæ­¢å®¹å™¨
docker stop my-app

# 7. åˆ é™¤å®¹å™¨
docker rm my-app
```

---

### Step 3ï¼šä½¿ç”¨ Docker Compose

**åˆ›å»º docker-compose.yml**ï¼š

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/myapp
    depends_on:
      - db

  db:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: myapp
    volumes:
      - db_data:/var/lib/postgresql/data

volumes:
  db_data:
```

**å¯åŠ¨æœåŠ¡**ï¼š

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down
```

---

### Step 4ï¼šInnoLiber é¡¹ç›®å¿«é€Ÿå¯åŠ¨

**æ“ä½œæ­¥éª¤**ï¼š

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/InnoLiber.git
cd InnoLiber

# 2. å¤åˆ¶ç¯å¢ƒå˜é‡é…ç½®
cp .env.example .env

# 3. ç¼–è¾‘ .env æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
# POSTGRES_PASSWORD=your_secure_password
# JWT_SECRET_KEY=your_secret_key

# 4. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# 5. ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆçº¦ 30 ç§’ï¼‰
docker-compose ps

# 6. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend
docker-compose logs -f frontend

# 7. è®¿é—®åº”ç”¨
# - å‰ç«¯ï¼šhttp://localhost:3000
# - åç«¯ APIï¼šhttp://localhost:8000/docs
# - pgAdminï¼šhttp://localhost:5050

# 8. åœæ­¢æœåŠ¡
docker-compose down

# 9. åœæ­¢å¹¶åˆ é™¤æ•°æ®å·ï¼ˆé‡ç½®æ•°æ®åº“ï¼‰
docker-compose down -v
```

---

## âš ï¸ å¸¸è§é™·é˜±ï¼ˆæ–°æ‰‹å¿…çœ‹ï¼‰

### é™·é˜± 1ï¼šå¿˜è®°æ·»åŠ  .dockerignore æ–‡ä»¶

```bash
# âŒ é”™è¯¯ï¼šæ²¡æœ‰ .dockerignoreï¼Œæ‰€æœ‰æ–‡ä»¶éƒ½ä¼šå¤åˆ¶åˆ°é•œåƒ
COPY . .
# ç»“æœï¼šnode_modulesã€.gitã€.venv ç­‰ä¸å¿…è¦æ–‡ä»¶è¢«å¤åˆ¶
# é—®é¢˜ï¼š
# - é•œåƒä½“ç§¯å·¨å¤§ï¼ˆå¯èƒ½è¶…è¿‡ 1GBï¼‰
# - æ„å»ºç¼“å­˜å¤±æ•ˆï¼ˆnode_modules å˜åŒ–å¯¼è‡´é‡æ–°æ„å»ºï¼‰
# - æ½œåœ¨çš„å®‰å…¨é£é™©ï¼ˆ.env æ–‡ä»¶è¢«å¤åˆ¶ï¼‰

# âœ… æ­£ç¡®ï¼šåˆ›å»º .dockerignore æ–‡ä»¶
# .dockerignore å†…å®¹ï¼š
node_modules
.git
.venv
__pycache__
*.pyc
.env
.env.local
dist
build
.DS_Store
```

---

### é™·é˜± 2ï¼šDockerfile å±‚é¡ºåºä¸å½“

```dockerfile
# âŒ é”™è¯¯ï¼šå…ˆå¤åˆ¶ä»£ç ï¼Œå†å®‰è£…ä¾èµ–
FROM node:20-alpine
WORKDIR /app
COPY . .                           # ä»£ç ä¿®æ”¹å¯¼è‡´ä¸‹é¢æ­¥éª¤ç¼“å­˜å¤±æ•ˆ
RUN npm install                    # æ¯æ¬¡éƒ½è¦é‡æ–°å®‰è£…ä¾èµ–
RUN npm run build

# âœ… æ­£ç¡®ï¼šå…ˆå¤åˆ¶ä¾èµ–é…ç½®ï¼Œå†å®‰è£…ä¾èµ–
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./              # åªå¤åˆ¶ä¾èµ–é…ç½®
RUN npm ci                         # åˆ©ç”¨ Docker ç¼“å­˜
COPY . .                           # ä»£ç ä¿®æ”¹ä¸å½±å“ä¾èµ–å®‰è£…
RUN npm run build
```

**åŸç†è§£é‡Š**ï¼š
```
Docker ç¼“å­˜æœºåˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: COPY package.json (ä¸å˜)             â”‚  â† ä½¿ç”¨ç¼“å­˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: RUN npm install (ä¸å˜)               â”‚  â† ä½¿ç”¨ç¼“å­˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: COPY . (ä»£ç å˜åŒ–)                    â”‚  â† é‡æ–°æ„å»º
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: RUN npm run build                     â”‚  â† é‡æ–°æ„å»º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### é™·é˜± 3ï¼šå®¹å™¨å†…ä½¿ç”¨ root ç”¨æˆ·

```dockerfile
# âŒ é”™è¯¯ï¼šä½¿ç”¨ root ç”¨æˆ·è¿è¡Œåº”ç”¨
FROM python:3.11-slim
WORKDIR /app
COPY . .
CMD ["python", "app.py"]
# é—®é¢˜ï¼š
# - å®‰å…¨é£é™©ï¼šå®¹å™¨è¢«æ”»å‡»åå¯ä»¥è·å– root æƒé™
# - æƒé™é—®é¢˜ï¼šå®¹å™¨å†…åˆ›å»ºçš„æ–‡ä»¶åœ¨å®¿ä¸»æœºä¸Šå±äº root

# âœ… æ­£ç¡®ï¼šåˆ›å»ºé root ç”¨æˆ·
FROM python:3.11-slim
WORKDIR /app

# åˆ›å»ºé root ç”¨æˆ·
RUN useradd -m -u 1000 appuser

# å¤åˆ¶æ–‡ä»¶å¹¶è®¾ç½®æ‰€æœ‰è€…
COPY --chown=appuser:appuser . .

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER appuser

CMD ["python", "app.py"]
```

---

### é™·é˜± 4ï¼šç«¯å£æ˜ å°„æ··æ·†

```bash
# âŒ é”™è¯¯ï¼šæ··æ·†å®¹å™¨ç«¯å£å’Œå®¿ä¸»æœºç«¯å£
docker run -p 3000:8000 my-app
# ç†è§£é”™è¯¯ï¼šè®¤ä¸ºåº”ç”¨ç›‘å¬ 3000 ç«¯å£

# âœ… æ­£ç¡®ç†è§£ç«¯å£æ˜ å°„
docker run -p 3000:8000 my-app
#           â†‘    â†‘
#           â”‚    â””â”€ å®¹å™¨å†…ç«¯å£ï¼ˆåº”ç”¨ç›‘å¬çš„ç«¯å£ï¼‰
#           â””â”€â”€â”€â”€â”€â”€ å®¿ä¸»æœºç«¯å£ï¼ˆå¤–éƒ¨è®¿é—®çš„ç«¯å£ï¼‰

# ç¤ºä¾‹ï¼š
# - åº”ç”¨åœ¨å®¹å™¨å†…ç›‘å¬ 8000 ç«¯å£
# - å¤–éƒ¨é€šè¿‡ http://localhost:3000 è®¿é—®
# - Docker è‡ªåŠ¨è½¬å‘ 3000 â†’ 8000
```

**ç«¯å£æ˜ å°„å›¾è§£**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å®¿ä¸»æœºï¼ˆä½ çš„ç”µè„‘ï¼‰                  â”‚
â”‚                                                    â”‚
â”‚  æµè§ˆå™¨è®¿é—® http://localhost:3000                 â”‚
â”‚       â†“                                            â”‚
â”‚  å®¿ä¸»æœºç«¯å£ 3000                                   â”‚
â”‚       â†“ (Docker ç«¯å£æ˜ å°„)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚         Docker å®¹å™¨                     â”‚      â”‚
â”‚  â”‚                                          â”‚      â”‚
â”‚  â”‚  å®¹å™¨å†…ç«¯å£ 8000                        â”‚      â”‚
â”‚  â”‚       â†“                                  â”‚      â”‚
â”‚  â”‚  åº”ç”¨ç›‘å¬ 0.0.0.0:8000                  â”‚      â”‚
â”‚  â”‚  (uvicorn/nginx/etc.)                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### é™·é˜± 5ï¼šå¿½ç•¥å¥åº·æ£€æŸ¥

```dockerfile
# âŒ é”™è¯¯ï¼šæ²¡æœ‰å¥åº·æ£€æŸ¥
FROM python:3.11-slim
# ... å…¶ä»–é…ç½® ...
CMD ["uvicorn", "app.main:app"]
# é—®é¢˜ï¼š
# - å®¹å™¨å¯åŠ¨ä¸ä»£è¡¨åº”ç”¨å°±ç»ª
# - è´Ÿè½½å‡è¡¡å™¨æ— æ³•åˆ¤æ–­å®¹å™¨å¥åº·çŠ¶æ€
# - ä¾èµ–å®¹å™¨å¯èƒ½åœ¨åº”ç”¨æœªå°±ç»ªæ—¶å°±å¼€å§‹è®¿é—®

# âœ… æ­£ç¡®ï¼šæ·»åŠ å¥åº·æ£€æŸ¥
FROM python:3.11-slim
# ... å…¶ä»–é…ç½® ...
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health', timeout=2)"
CMD ["uvicorn", "app.main:app"]
```

**å¥åº·æ£€æŸ¥çš„é‡è¦æ€§**ï¼š
```yaml
# docker-compose.yml ä¸­ä½¿ç”¨å¥åº·æ£€æŸ¥
services:
  backend:
    # ...
    depends_on:
      postgres:
        condition: service_healthy  # ğŸ”‘ ç­‰å¾… postgres å¥åº·
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    # ...
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
```

---

### é™·é˜± 6ï¼šæ•°æ®å·æŒ‚è½½è·¯å¾„é”™è¯¯

```bash
# âŒ é”™è¯¯ï¼šWindows è·¯å¾„æ ¼å¼ä¸æ­£ç¡®
docker run -v C:\Users\data:/app/data my-app
# é”™è¯¯ï¼šDocker ä¸è¯†åˆ« Windows è·¯å¾„

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ / åˆ†éš”ç¬¦
docker run -v /c/Users/data:/app/data my-app
# æˆ–ä½¿ç”¨ $(pwd)ï¼ˆå½“å‰ç›®å½•ï¼‰
docker run -v $(pwd)/data:/app/data my-app

# âŒ é”™è¯¯ï¼šç›¸å¯¹è·¯å¾„
docker run -v ./data:/app/data my-app
# é—®é¢˜ï¼šç›¸å¯¹è·¯å¾„å¯èƒ½å¯¼è‡´è·¯å¾„è§£æé”™è¯¯

# âœ… æ­£ç¡®ï¼šç»å¯¹è·¯å¾„æˆ– $(pwd)
docker run -v $(pwd)/data:/app/data my-app
```

---

### é™·é˜± 7ï¼šå¿˜è®°æ¸…ç†æ—§é•œåƒå’Œå®¹å™¨

```bash
# âŒ é—®é¢˜ï¼šé•¿æœŸä½¿ç”¨ Docker åç£ç›˜ç©ºé—´ä¸è¶³
docker images
# Output: 50+ ä¸ªé•œåƒï¼Œå ç”¨ 50GB ç©ºé—´

# âœ… è§£å†³æ–¹æ¡ˆï¼šå®šæœŸæ¸…ç†

# 1. åˆ é™¤åœæ­¢çš„å®¹å™¨
docker container prune
# æˆ–
docker rm $(docker ps -aq -f status=exited)

# 2. åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ
docker image prune
# æˆ–åˆ é™¤æ‰€æœ‰æœªè¢«å®¹å™¨ä½¿ç”¨çš„é•œåƒ
docker image prune -a

# 3. åˆ é™¤æœªä½¿ç”¨çš„æ•°æ®å·
docker volume prune

# 4. åˆ é™¤æœªä½¿ç”¨çš„ç½‘ç»œ
docker network prune

# 5. ä¸€é”®æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨èµ„æº
docker system prune -a --volumes
# è­¦å‘Šï¼šä¼šåˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨ã€æœªä½¿ç”¨çš„é•œåƒå’Œæ•°æ®å·

# 6. æŸ¥çœ‹ Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ
docker system df
# Output:
# TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
# Images          10        5         5.5GB     2.1GB (38%)
# Containers      8         3         1.2GB     800MB (66%)
# Local Volumes   15        5         3.3GB     1.8GB (54%)
```

---

## ğŸ“š å­¦ä¹ èµ„æº

### å®˜æ–¹èµ„æº
- **Docker å®˜æ–¹æ–‡æ¡£**ï¼šhttps://docs.docker.com/
- **Context7 æŸ¥è¯¢ç»“æœ**ï¼š`/websites/docs_docker_com` (å·²æŸ¥è¯¢)
- **Docker Hub**ï¼šhttps://hub.docker.com/ - å®˜æ–¹é•œåƒä»“åº“
- **Docker Compose æ–‡æ¡£**ï¼šhttps://docs.docker.com/compose/

### é¡¹ç›®ä¸­çš„å‚è€ƒæ–‡ä»¶
- **åç«¯é•œåƒ**ï¼š`backend/Dockerfile` - å¤šé˜¶æ®µæ„å»ºç¤ºä¾‹
- **å‰ç«¯é•œåƒ**ï¼š`frontend/Dockerfile` - Nginx é…ç½®
- **æœåŠ¡ç¼–æ’**ï¼š`docker-compose.yml` - 6 æœåŠ¡ç¼–æ’
- **Nginx é…ç½®**ï¼š`frontend/nginx.conf` - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

### è¿›é˜¶å­¦ä¹ ä¸»é¢˜
- **Docker ç½‘ç»œè¯¦è§£**ï¼šbridgeã€hostã€overlay ç½‘ç»œæ¨¡å¼
- **Docker Swarm**ï¼šDocker å®˜æ–¹é›†ç¾¤ç®¡ç†å·¥å…·
- **Kubernetes**ï¼šæ›´å¼ºå¤§çš„å®¹å™¨ç¼–æ’å¹³å°
- **é•œåƒå®‰å…¨æ‰«æ**ï¼šTrivyã€Clair ç­‰å·¥å…·
- **CI/CD é›†æˆ**ï¼šGitHub Actionsã€GitLab CI ä¸­ä½¿ç”¨ Docker

---

## ğŸ¯ å®è·µç»ƒä¹ å»ºè®®

### ç»ƒä¹  1ï¼šåˆ›å»ºç®€å•çš„ Python Web åº”ç”¨å®¹å™¨

```dockerfile
# ä»»åŠ¡ï¼šä¸ºä»¥ä¸‹åº”ç”¨åˆ›å»º Dockerfile
# app.py
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return "Hello from Docker!"

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

**è¦æ±‚**ï¼š
- ä½¿ç”¨ Python 3.11 åŸºç¡€é•œåƒ
- å®‰è£… Flask
- æš´éœ² 5000 ç«¯å£
- æ·»åŠ å¥åº·æ£€æŸ¥

---

### ç»ƒä¹  2ï¼šåˆ›å»ºå¤šé˜¶æ®µæ„å»ºçš„ Node.js åº”ç”¨

```dockerfile
# ä»»åŠ¡ï¼šä¼˜åŒ–ä»¥ä¸‹ Dockerfile
FROM node:20
WORKDIR /app
COPY . .
RUN npm install
RUN npm run build
CMD ["node", "dist/index.js"]
```

**è¦æ±‚**ï¼š
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»º
- ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºåº”ç”¨
- ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œåº”ç”¨
- å‡å°é•œåƒä½“ç§¯

---

### ç»ƒä¹  3ï¼šä½¿ç”¨ Docker Compose ç¼–æ’æ•°æ®åº“

```yaml
# ä»»åŠ¡ï¼šåˆ›å»º docker-compose.ymlï¼Œå¯åŠ¨ PostgreSQL + pgAdmin
# è¦æ±‚ï¼š
# - PostgreSQL 16
# - pgAdmin4
# - æ•°æ®æŒä¹…åŒ–
# - å¥åº·æ£€æŸ¥
```

---

## âœ… å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼Œè¯´æ˜ä½ å·²ç»æŒæ¡ Docker å®¹å™¨åŒ–åŸºç¡€ï¼š

- [ ] **ç†è§£æ ¸å¿ƒæ¦‚å¿µ**ï¼šèƒ½è§£é‡Šé•œåƒã€å®¹å™¨ã€ä»“åº“çš„åŒºåˆ«
- [ ] **ä¼šç¼–å†™ Dockerfile**ï¼šæŒæ¡ FROMã€COPYã€RUNã€CMD ç­‰æŒ‡ä»¤
- [ ] **ç†è§£å¤šé˜¶æ®µæ„å»º**ï¼šçŸ¥é“ä¸ºä»€ä¹ˆéœ€è¦å¤šé˜¶æ®µæ„å»º
- [ ] **ä¼šä½¿ç”¨æ•°æ®å·**ï¼šç†è§£å‘½åå·å’Œç»‘å®šæŒ‚è½½çš„åŒºåˆ«
- [ ] **ä¼šé…ç½®ç½‘ç»œ**ï¼šç†è§£ bridge ç½‘ç»œæ¨¡å¼å’Œå®¹å™¨é€šä¿¡
- [ ] **ä¼šæ·»åŠ å¥åº·æ£€æŸ¥**ï¼šçŸ¥é“å¦‚ä½•é…ç½® HEALTHCHECK
- [ ] **ä¼šä½¿ç”¨ Docker Compose**ï¼šèƒ½ç¼–å†™å¤šæœåŠ¡ç¼–æ’é…ç½®
- [ ] **ä¼šç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ**ï¼šstartã€stopã€restartã€logs ç­‰å‘½ä»¤
- [ ] **ç†è§£ç¯å¢ƒå˜é‡**ï¼šä¼šé€šè¿‡ .env æ–‡ä»¶é…ç½®åº”ç”¨
- [ ] **èƒ½é¿å…å¸¸è§é™·é˜±**ï¼š.dockerignoreã€å±‚é¡ºåºã€ç«¯å£æ˜ å°„ç­‰

---

## ğŸ“ ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆæœ¬æ–‡æ¡£åï¼Œå»ºè®®ç»§ç»­å­¦ä¹ ï¼š

1. **Docker Compose æ·±å…¥**ï¼š`11_docker_compose_multi_service.md` - å¤šæœåŠ¡ç¼–æ’
2. **é¡¹ç›®æ¶æ„æ€»è§ˆ**ï¼š`12_project_architecture_overview.md` - ç³»ç»Ÿæ¶æ„è®¾è®¡
3. **å¼€å‘å·¥ä½œæµ**ï¼š`13_development_workflow.md` - å®Œæ•´å¼€å‘æµç¨‹
4. **é¡¹ç›®å®æˆ˜**ï¼šå°è¯•ä¸ºæ–°åŠŸèƒ½ç¼–å†™ Dockerfile

---

## ğŸš€ å®é™…é¡¹ç›®åº”ç”¨

**åœ¨ InnoLiber é¡¹ç›®ä¸­çš„ä½¿ç”¨åœºæ™¯**ï¼š

1. **å¼€å‘ç¯å¢ƒç»Ÿä¸€**ï¼šæ‰€æœ‰å›¢é˜Ÿæˆå‘˜ä½¿ç”¨ç›¸åŒçš„æ•°æ®åº“å’Œç¼“å­˜ç‰ˆæœ¬
2. **ä¸€é”®å¯åŠ¨**ï¼š`docker-compose up -d` å¯åŠ¨å®Œæ•´å¼€å‘ç¯å¢ƒ
3. **æœåŠ¡éš”ç¦»**ï¼šåç«¯ã€å‰ç«¯ã€æ•°æ®åº“ã€ç¼“å­˜å„è‡ªç‹¬ç«‹å®¹å™¨
4. **æ•°æ®æŒä¹…åŒ–**ï¼šæ•°æ®åº“æ•°æ®åœ¨å®¹å™¨é‡å¯åä»ç„¶ä¿ç•™
5. **å¥åº·æ£€æŸ¥**ï¼šè‡ªåŠ¨æ£€æµ‹æœåŠ¡å¥åº·çŠ¶æ€ï¼Œå¼‚å¸¸æ—¶è‡ªåŠ¨é‡å¯

**é¡¹ç›®ç‰¹è‰²å®ç°**ï¼š
- âœ… åç«¯å¤šé˜¶æ®µæ„å»ºï¼ˆPoetry + Pythonï¼‰
- âœ… å‰ç«¯å¤šé˜¶æ®µæ„å»ºï¼ˆVite + Nginxï¼‰
- âœ… 6 æœåŠ¡ç¼–æ’ï¼ˆPostgreSQLã€Redisã€åç«¯ã€Celeryã€å‰ç«¯ã€pgAdminï¼‰
- âœ… å®Œæ•´çš„å¥åº·æ£€æŸ¥ï¼ˆæ‰€æœ‰å…³é”®æœåŠ¡ï¼‰
- âœ… æ•°æ®å·æŒä¹…åŒ–ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ã€é…ç½®ï¼‰
- âœ… é root ç”¨æˆ·è¿è¡Œï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰

**å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥**ï¼š
```bash
# æ„å»ºé•œåƒ
docker build -t my-app .

# è¿è¡Œå®¹å™¨
docker run -d -p 8000:8000 --name my-app my-app

# Docker Compose
docker-compose up -d              # å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose ps                 # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose logs -f backend    # æŸ¥çœ‹æ—¥å¿—
docker-compose down               # åœæ­¢æ‰€æœ‰æœåŠ¡

# å®¹å™¨ç®¡ç†
docker ps                         # æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
docker ps -a                      # æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
docker stop container_name        # åœæ­¢å®¹å™¨
docker rm container_name          # åˆ é™¤å®¹å™¨

# é•œåƒç®¡ç†
docker images                     # æŸ¥çœ‹é•œåƒ
docker rmi image_name             # åˆ é™¤é•œåƒ
docker image prune -a             # æ¸…ç†æœªä½¿ç”¨é•œåƒ

# æ•°æ®å·ç®¡ç†
docker volume ls                  # æŸ¥çœ‹æ•°æ®å·
docker volume rm volume_name      # åˆ é™¤æ•°æ®å·

# æ¸…ç†èµ„æº
docker system prune -a --volumes  # æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨èµ„æº
docker system df                  # æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-11-15
**ç»´æŠ¤è€…**ï¼šInnoLiber Team
**å‚è€ƒæ¥æº**ï¼šContext7 - Docker å®˜æ–¹æ–‡æ¡£
