# Alembic æ•°æ®åº“è¿ç§»è¯¦è§£

> **é€‚åˆäººç¾¤**ï¼šäº†è§£æ•°æ®åº“åŸºç¡€å’Œ SQLAlchemy çš„å¼€å‘è€…
>
> **å­¦ä¹ æ—¶é•¿**ï¼šçº¦ 35-45 åˆ†é’Ÿ
>
> **å…ˆä¿®çŸ¥è¯†**ï¼šSQLAlchemy åŸºç¡€ã€æ•°æ®åº“åŸºæœ¬æ¦‚å¿µã€Git ç‰ˆæœ¬æ§åˆ¶æ¦‚å¿µ

---

## ğŸ“Œ ä»€ä¹ˆæ˜¯ Alembicï¼Ÿ

**ä¸€å¥è¯è§£é‡Š**ï¼šAlembic æ˜¯ SQLAlchemy çš„æ•°æ®åº“è¿ç§»å·¥å…·ï¼Œè®©ä½ åƒä½¿ç”¨ Git ç®¡ç†ä»£ç ä¸€æ ·ç®¡ç†æ•°æ®åº“çš„ç‰ˆæœ¬å˜åŒ–ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“è¿ç§»ï¼Ÿ

**é—®é¢˜åœºæ™¯**ï¼šä½ çš„é¡¹ç›®å¼€å‘äº†3ä¸ªæœˆï¼Œæ•°æ®åº“å·²ç»æœ‰äº†ç”¨æˆ·æ•°æ®ã€‚ç°åœ¨ä½ éœ€è¦ç»™ç”¨æˆ·è¡¨æ·»åŠ ä¸€ä¸ªæ–°å­—æ®µ`phone`ï¼Œæ€ä¹ˆåŠï¼Ÿ

**æ²¡æœ‰è¿ç§»å·¥å…·ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰**ï¼š
```sql
-- æ‰‹åŠ¨å†™ SQL è¯­å¥
ALTER TABLE users ADD COLUMN phone VARCHAR(20);

-- é—®é¢˜ï¼š
-- âŒ å›¢é˜Ÿæˆå‘˜çš„æ•°æ®åº“ä¸ä¸€è‡´
-- âŒ ç”Ÿäº§ç¯å¢ƒæ›´æ–°å¾ˆå±é™©
-- âŒ æ— æ³•å›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€
-- âŒ æ— æ³•è¿½è¸ªæ•°æ®åº“å˜åŒ–å†å²
```

**æœ‰ Alembicï¼ˆç°ä»£æ–¹å¼ï¼‰**ï¼š
```python
# è‡ªåŠ¨ç”Ÿæˆè¿ç§»è„šæœ¬
alembic revision --autogenerate -m "add phone column to users"

# å‡çº§æ•°æ®åº“
alembic upgrade head

# å¦‚æœæœ‰é—®é¢˜ï¼Œå›æ»š
alembic downgrade -1
```

**Alembic çš„ä¼˜åŠ¿**ï¼š
- âœ… **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ¯ä¸ªæ•°æ®åº“å˜æ›´éƒ½æœ‰å”¯ä¸€IDï¼ŒåƒGit commitä¸€æ ·
- âœ… **å›¢é˜Ÿåä½œ**ï¼šæ‰€æœ‰äººå…±äº«ç›¸åŒçš„è¿ç§»è„šæœ¬
- âœ… **è‡ªåŠ¨æ£€æµ‹**ï¼šå¯¹æ¯”ORMæ¨¡å‹å’Œæ•°æ®åº“ï¼Œè‡ªåŠ¨ç”Ÿæˆå˜æ›´è„šæœ¬
- âœ… **åŒå‘æ“ä½œ**ï¼šæ”¯æŒå‡çº§ï¼ˆupgradeï¼‰å’Œé™çº§ï¼ˆdowngradeï¼‰
- âœ… **ç”Ÿäº§å®‰å…¨**ï¼šå¯ä»¥å…ˆç”ŸæˆSQLé¢„è§ˆï¼Œå†æ‰§è¡Œ

### åœ¨ InnoLiber é¡¹ç›®ä¸­çš„åº”ç”¨

åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼ŒAlembic è´Ÿè´£ï¼š
- âœ… **ç®¡ç† User æ¨¡å‹å˜åŒ–**ï¼šæ·»åŠ è®¤è¯å­—æ®µã€é‚®ç®±éªŒè¯ç­‰
- âœ… **ç®¡ç† Proposal æ¨¡å‹å˜åŒ–**ï¼šAIè¯„åˆ†å­—æ®µã€æ–‡ä»¶å­˜å‚¨ç­‰
- âœ… **ä¿æŒå¼€å‘å’Œç”Ÿäº§æ•°æ®åº“åŒæ­¥**ï¼šç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§
- âœ… **æ”¯æŒå›¢é˜Ÿåä½œ**ï¼šæ–°æˆå‘˜å¿«é€Ÿæ­å»ºç›¸åŒçš„æ•°æ®åº“ç»“æ„

**é¡¹ç›®æ–‡ä»¶ä½ç½®**ï¼š
- é…ç½®ï¼š`backend/alembic.ini`
- ç¯å¢ƒè„šæœ¬ï¼š`backend/alembic/env.py`
- è¿ç§»è„šæœ¬ï¼š`backend/alembic/versions/`

---

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µï¼ˆç”¨æ—¥å¸¸è¯­è¨€ç†è§£ï¼‰

### 1. è¿ç§»ç‰ˆæœ¬ï¼ˆMigration Revisionï¼‰= Git Commit

**ç±»æ¯”**ï¼šAlembic çš„è¿ç§»å°±åƒ Git çš„æäº¤è®°å½•ï¼Œæ¯ä¸ªå˜æ›´éƒ½æœ‰å”¯ä¸€æ ‡è¯†ã€‚

**é¡¹ç›®å®ä¾‹**ï¼ˆæ¥è‡ª `backend/alembic/versions/9a6e37957675_initial_database_schema_with_user_and_.py`ï¼‰ï¼š

```python
"""Initial database schema with User and Proposal models

Revision ID: 9a6e37957675  # ğŸ”‘ å”¯ä¸€æ ‡è¯†ï¼ˆåƒGitçš„commit hashï¼‰
Revises:                   # ğŸ”‘ çˆ¶ç‰ˆæœ¬ï¼ˆè¿™æ˜¯ç¬¬ä¸€ä¸ªè¿ç§»ï¼Œæ‰€ä»¥ä¸ºç©ºï¼‰
Create Date: 2025-11-15 11:56:02.526333  # ğŸ”‘ åˆ›å»ºæ—¶é—´

"""

# revision identifiers, used by Alembic.
revision: str = '9a6e37957675'           # å½“å‰ç‰ˆæœ¬ID
down_revision: Union[str, None] = None   # çˆ¶ç‰ˆæœ¬IDï¼ˆNoneè¡¨ç¤ºåˆå§‹ç‰ˆæœ¬ï¼‰
branch_labels: Union[str, None] = None   # åˆ†æ”¯æ ‡ç­¾ï¼ˆç”¨äºå¤æ‚çš„åˆ†æ”¯ç®¡ç†ï¼‰
depends_on: Union[str, None] = None      # ä¾èµ–çš„å…¶ä»–è¿ç§»
```

**ç‰ˆæœ¬é“¾æ¡ç¤ºä¾‹**ï¼š
```
None â†’ 9a6e37957675 â†’ ae1027a6acf â†’ 1b2c3d4e5f6g
 |         |              |            |
åˆå§‹      åˆ›å»ºç”¨æˆ·è¡¨     æ·»åŠ å­—æ®µ      æ·»åŠ ç´¢å¼•
```

### 2. å‡çº§å’Œé™çº§ï¼ˆUpgrade & Downgradeï¼‰= å‰è¿›å’Œåé€€

**ç±»æ¯”**ï¼šå°±åƒGitå¯ä»¥checkoutåˆ°ä»»æ„commitï¼ŒAlembicå¯ä»¥è¿ç§»åˆ°ä»»æ„æ•°æ®åº“ç‰ˆæœ¬ã€‚

**å‡çº§å‡½æ•°ï¼ˆUpgradeï¼‰**ï¼š
```python
def upgrade() -> None:
    """å‘å‰è¿ç§»ï¼šåˆ›å»ºæ–°è¡¨ã€æ·»åŠ å­—æ®µç­‰"""
    # åˆ›å»º users è¡¨
    op.create_table('users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('username', sa.String(length=50), nullable=False),
        sa.Column('email', sa.String(length=100), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )

    # åˆ›å»ºç´¢å¼•
    op.create_index('ix_users_email', 'users', ['email'], unique=True)
```

**é™çº§å‡½æ•°ï¼ˆDowngradeï¼‰**ï¼š
```python
def downgrade() -> None:
    """å‘åè¿ç§»ï¼šæ’¤é”€upgradeçš„æ“ä½œ"""
    # åˆ é™¤ç´¢å¼•ï¼ˆä¸upgradeç›¸åçš„æ“ä½œï¼‰
    op.drop_index('ix_users_email', table_name='users')

    # åˆ é™¤è¡¨
    op.drop_table('users')
```

**é‡è¦åŸåˆ™**ï¼š
- æ¯ä¸ª`upgrade`æ“ä½œéƒ½åº”è¯¥æœ‰å¯¹åº”çš„`downgrade`æ“ä½œ
- `downgrade`åº”è¯¥å®Œå…¨æ’¤é”€`upgrade`çš„æ•ˆæœ

### 3. è‡ªåŠ¨ç”Ÿæˆï¼ˆAutogenerateï¼‰= æ™ºèƒ½å·®å¼‚æ£€æµ‹

**ç±»æ¯”**ï¼šå°±åƒIDEèƒ½è‡ªåŠ¨æ£€æµ‹ä»£ç å˜åŒ–ï¼ŒAlembicèƒ½è‡ªåŠ¨æ£€æµ‹æ•°æ®åº“æ¨¡å‹å˜åŒ–ã€‚

**å·¥ä½œåŸç†**ï¼š

```python
# Step 1: ä½ ä¿®æ”¹äº† User æ¨¡å‹
class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    username = Column(String(50), nullable=False)
    email = Column(String(100), nullable=False)
    phone = Column(String(20), nullable=True)  # ğŸ”¥ æ–°å¢å­—æ®µï¼

# Step 2: Alembic è‡ªåŠ¨æ£€æµ‹å·®å¼‚
alembic revision --autogenerate -m "add phone to users"

# Step 3: Alembic è‡ªåŠ¨ç”Ÿæˆè¿ç§»è„šæœ¬
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('phone', sa.String(20), nullable=True))
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'phone')
    # ### end Alembic commands ###
```

### 4. ç¯å¢ƒé…ç½®ï¼ˆenv.pyï¼‰= è¿ç§»è¿è¡Œç¯å¢ƒ

**é¡¹ç›®å®ä¾‹**ï¼ˆæ¥è‡ª `backend/alembic/env.py`ï¼‰ï¼š

```python
# å¯¼å…¥é¡¹ç›®çš„é…ç½®å’Œæ¨¡å‹
from app.core.config import settings
from app.models.base import Base
from app.models import user, proposal  # ğŸ”‘ å¯¼å…¥æ‰€æœ‰æ¨¡å‹

# æ•°æ®åº“URLå¤„ç†ï¼ˆå¼‚æ­¥è½¬åŒæ­¥ï¼‰
database_url = settings.DATABASE_URL
# Alembicä¸æ”¯æŒasyncpgï¼Œéœ€è¦è½¬æ¢ä¸ºpsycopg2
if "+asyncpg" in database_url:
    database_url = database_url.replace("+asyncpg", "")
config.set_main_option("sqlalchemy.url", database_url)

# ğŸ”‘ æŒ‡å®šæ¨¡å‹å…ƒæ•°æ®ï¼ˆå‘Šè¯‰Alembicè¦æ¯”è¾ƒå“ªäº›è¡¨ï¼‰
target_metadata = Base.metadata

def run_migrations_online() -> None:
    """åœ¨çº¿æ¨¡å¼ï¼šè¿æ¥æ•°æ®åº“æ‰§è¡Œè¿ç§»"""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,  # ğŸ”‘ ä¸ä½¿ç”¨è¿æ¥æ± ï¼ˆé¿å…å†²çªï¼‰
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata  # ğŸ”‘ ä¼ å…¥æ¨¡å‹å…ƒæ•°æ®
        )

        with context.begin_transaction():
            context.run_migrations()
```

**å…³é”®é…ç½®è¯´æ˜**ï¼š
- `target_metadata = Base.metadata`ï¼šå‘Šè¯‰Alembicæ¯”è¾ƒå“ªäº›ORMæ¨¡å‹
- æ•°æ®åº“URLè½¬æ¢ï¼šä»`asyncpg`è½¬ä¸º`psycopg2`ï¼ˆAlembicé™åˆ¶ï¼‰
- å¯¼å…¥æ‰€æœ‰æ¨¡å‹ï¼šç¡®ä¿autogenerateèƒ½æ£€æµ‹åˆ°æ‰€æœ‰è¡¨

---

## ğŸ’» é¡¹ç›®ä¸­çš„å®é™…åº”ç”¨

### ç¤ºä¾‹ 1ï¼šåˆå§‹æ•°æ®åº“è¿ç§»

**æ–‡ä»¶ä½ç½®**ï¼š`backend/alembic/versions/9a6e37957675_initial_database_schema_with_user_and_.py`

```python
def upgrade() -> None:
    """åˆ›å»ºåˆå§‹æ•°æ®åº“ç»“æ„"""

    # åˆ›å»º users è¡¨ï¼ˆå®Œæ•´å­—æ®µå®šä¹‰ï¼‰
    op.create_table('users',
        # åŸºç¡€å­—æ®µ
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('username', sa.String(50), nullable=False, comment='ç”¨æˆ·å'),
        sa.Column('email', sa.String(100), nullable=False, comment='é‚®ç®±'),
        sa.Column('full_name', sa.String(100), nullable=False, comment='çœŸå®å§“å'),
        sa.Column('hashed_password', sa.String(255), nullable=False, comment='å“ˆå¸Œå¯†ç ï¼ˆbcryptï¼‰'),

        # ä¸ªäººä¿¡æ¯å­—æ®µ
        sa.Column('avatar_url', sa.String(255), nullable=True, comment='å¤´åƒURL'),
        sa.Column('institution', sa.String(200), nullable=True, comment='æ‰€å±æœºæ„'),
        sa.Column('department', sa.String(200), nullable=True, comment='æ‰€å±é™¢ç³»'),
        sa.Column('position', sa.String(100), nullable=True, comment='èŒä½'),
        sa.Column('phone', sa.String(20), nullable=True, comment='æ‰‹æœºå·'),
        sa.Column('research_field', sa.String(100), nullable=True, comment='ç ”ç©¶æ–¹å‘'),

        # çŠ¶æ€æ ‡è®°å­—æ®µ
        sa.Column('is_active', sa.Boolean(), default=True, comment='è´¦æˆ·æ˜¯å¦æ¿€æ´»'),
        sa.Column('is_superuser', sa.Boolean(), default=False, comment='æ˜¯å¦ä¸ºç®¡ç†å‘˜'),
        sa.Column('email_verified', sa.Boolean(), default=False, comment='é‚®ç®±æ˜¯å¦å·²éªŒè¯'),
        sa.Column('is_edu_email', sa.Boolean(), default=False, comment='æ˜¯å¦ä¸ºæ•™è‚²é‚®ç®±'),

        # å®‰å…¨ç›¸å…³å­—æ®µ
        sa.Column('verify_token', sa.String(255), nullable=True, comment='é‚®ç®±éªŒè¯ä»¤ç‰Œ'),
        sa.Column('verify_token_expires', sa.DateTime(timezone=True), nullable=True, comment='ä»¤ç‰Œè¿‡æœŸæ—¶é—´'),
        sa.Column('failed_login_attempts', sa.Integer(), default=0, comment='ç™»å½•å¤±è´¥æ¬¡æ•°'),
        sa.Column('locked_until', sa.DateTime(timezone=True), nullable=True, comment='è´¦æˆ·é”å®šè‡³'),

        # æ—¶é—´æˆ³å­—æ®µ
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), comment='æ³¨å†Œæ—¶é—´'),
        sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), comment='æ›´æ–°æ—¶é—´'),
        sa.Column('last_login', sa.DateTime(timezone=True), nullable=True, comment='æœ€åç™»å½•æ—¶é—´'),

        # ä¸»é”®çº¦æŸ
        sa.PrimaryKeyConstraint('id')
    )

    # åˆ›å»ºç´¢å¼•ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
    op.create_index('ix_users_email', 'users', ['email'], unique=True)     # é‚®ç®±å”¯ä¸€ç´¢å¼•
    op.create_index('ix_users_username', 'users', ['username'], unique=True) # ç”¨æˆ·åå”¯ä¸€ç´¢å¼•
    op.create_index('ix_users_id', 'users', ['id'], unique=False)          # IDæ™®é€šç´¢å¼•

    # åˆ›å»º proposals è¡¨
    op.create_table('proposals',
        # åŸºç¡€ä¿¡æ¯
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('title', sa.String(500), nullable=False),
        sa.Column('description', sa.Text(), nullable=True),
        sa.Column('content', sa.Text(), nullable=True),
        sa.Column('status', sa.String(20), nullable=False, comment='draft/reviewing/completed/submitted'),

        # å…³è”å…³ç³»
        sa.Column('owner_id', sa.Integer(), nullable=False),  # å¤–é”®å­—æ®µ

        # ç”³è¯·ä¿¡æ¯
        sa.Column('funding_agency', sa.String(200), nullable=True, comment='èµ„åŠ©æœºæ„'),
        sa.Column('funding_amount', sa.Integer(), nullable=True, comment='ç”³è¯·é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰'),
        sa.Column('project_duration', sa.Integer(), nullable=True, comment='é¡¹ç›®æœŸé™ï¼ˆæœˆï¼‰'),
        sa.Column('research_field', sa.String(100), nullable=True, comment='ç ”ç©¶é¢†åŸŸ'),
        sa.Column('keywords', sa.JSON(), nullable=True, comment='å…³é”®è¯æ•°ç»„'),

        # AIè¯„åˆ†ç³»ç»Ÿ
        sa.Column('quality_score', sa.Float(), nullable=True, comment='ç»¼åˆè´¨é‡ 0-10'),
        sa.Column('content_score', sa.Float(), nullable=True, comment='å†…å®¹è´¨é‡ 0-10'),
        sa.Column('format_score', sa.Float(), nullable=True, comment='æ ¼å¼è§„èŒƒ 0-10'),
        sa.Column('innovation_score', sa.Float(), nullable=True, comment='åˆ›æ–°ç¨‹åº¦ 0-10'),
        sa.Column('ai_suggestions', sa.JSON(), nullable=True, comment='AI ä¿®æ”¹å»ºè®®'),
        sa.Column('ai_analysis', sa.JSON(), nullable=True, comment='AI åˆ†ææŠ¥å‘Š'),

        # æ–‡ä»¶ç³»ç»Ÿ
        sa.Column('files', sa.JSON(), nullable=True, comment="é™„ä»¶åˆ—è¡¨ [{'name': '...', 'url': '...'}]"),

        # æ—¶é—´æˆ³
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), comment='åˆ›å»ºæ—¶é—´'),
        sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), comment='æ›´æ–°æ—¶é—´'),
        sa.Column('submitted_at', sa.DateTime(timezone=True), nullable=True, comment='æäº¤æ—¶é—´'),

        # çº¦æŸå®šä¹‰
        sa.ForeignKeyConstraint(['owner_id'], ['users.id'], ondelete='CASCADE'),  # å¤–é”®çº¦æŸ
        sa.PrimaryKeyConstraint('id')
    )

    # åˆ›å»ºproposalsç´¢å¼•
    op.create_index('ix_proposals_title', 'proposals', ['title'], unique=False)
    op.create_index('ix_proposals_id', 'proposals', ['id'], unique=False)
```

**é‡è¦ç‰¹æ€§åˆ†æ**ï¼š
- **Commentæ”¯æŒ**ï¼šæ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸­æ–‡æ³¨é‡Šï¼Œä¾¿äºç†è§£
- **JSONå­—æ®µ**ï¼š`keywords`ã€`ai_suggestions`ç­‰ä½¿ç”¨JSONå­˜å‚¨å¤æ‚æ•°æ®
- **å¤–é”®çº¦æŸ**ï¼š`owner_id`å…³è”åˆ°`users.id`ï¼Œä¸”çº§è”åˆ é™¤
- **æ—¶é—´æˆ³è‡ªåŠ¨åŒ–**ï¼šä½¿ç”¨`server_default=sa.text('now()')`è‡ªåŠ¨è®¾ç½®æ—¶é—´

### ç¤ºä¾‹ 2ï¼šé…ç½®æ–‡ä»¶è§£æ

**æ–‡ä»¶ä½ç½®**ï¼š`backend/alembic.ini`ï¼ˆæ ¸å¿ƒé…ç½®ï¼‰

```ini
[alembic]
# ğŸ”‘ è¿ç§»è„šæœ¬ä½ç½®
script_location = %(here)s/alembic

# ğŸ”‘ æ•°æ®åº“è¿æ¥ï¼ˆå ä½ç¬¦ï¼Œå®é™…ä»env.pyè¯»å–ï¼‰
sqlalchemy.url = driver://user:pass@localhost/dbname

# ğŸ”‘ ç³»ç»Ÿè·¯å¾„é…ç½®ï¼ˆè®©Alembicæ‰¾åˆ°appæ¨¡å—ï¼‰
prepend_sys_path = .

# ğŸ”‘ æ–‡ä»¶æ¨¡æ¿ï¼ˆå¯è‡ªå®šä¹‰è¿ç§»æ–‡ä»¶å‘½åæ ¼å¼ï¼‰
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

[post_write_hooks]
# ğŸ”‘ ä»£ç æ ¼å¼åŒ–ï¼ˆå¯é€‰ï¼‰
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# ğŸ”‘ æ—¥å¿—é…ç½®
[loggers]
keys = root,sqlalchemy,alembic

[logger_alembic]
level = INFO  # æ˜¾ç¤ºè¿ç§»è¿‡ç¨‹ä¿¡æ¯
```

**é…ç½®è§£é‡Š**ï¼š
- `script_location`ï¼šè¿ç§»è„šæœ¬å­˜æ”¾ç›®å½•
- `prepend_sys_path = .`ï¼šè®©Pythonèƒ½æ‰¾åˆ°`app`æ¨¡å—
- `post_write_hooks`ï¼šå¯é…ç½®è‡ªåŠ¨æ ¼å¼åŒ–æ–°ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶

### ç¤ºä¾‹ 3ï¼šç¯å¢ƒè„šæœ¬çš„å…³é”®é€»è¾‘

**æ–‡ä»¶ä½ç½®**ï¼š`backend/alembic/env.py`ï¼ˆç¬¬22-27è¡Œï¼‰

```python
# ğŸ”‘ æ•°æ®åº“URLè½¬æ¢é€»è¾‘
database_url = settings.DATABASE_URL
# å°† postgresql+asyncpg:// æ›¿æ¢ä¸º postgresql://
# å› ä¸ºAlembicä¸æ”¯æŒasyncpgå¼‚æ­¥é©±åŠ¨ï¼Œå¿…é¡»ä½¿ç”¨psycopg2åŒæ­¥é©±åŠ¨
if "+asyncpg" in database_url:
    database_url = database_url.replace("+asyncpg", "")
config.set_main_option("sqlalchemy.url", database_url)
```

**ä¸ºä»€ä¹ˆéœ€è¦URLè½¬æ¢ï¼Ÿ**
- FastAPIåº”ç”¨ä½¿ç”¨ï¼š`postgresql+asyncpg://...`ï¼ˆå¼‚æ­¥ï¼‰
- Alembicåªæ”¯æŒï¼š`postgresql://...`ï¼ˆåŒæ­¥ï¼‰
- è§£å†³æ–¹æ¡ˆï¼šè¿è¡Œæ—¶è‡ªåŠ¨è½¬æ¢URL

**æ¨¡å‹å¯¼å…¥ï¼ˆç¬¬14-16è¡Œï¼‰**ï¼š
```python
from app.core.config import settings
from app.models.base import Base
from app.models import user, proposal  # ğŸ”‘ å¿…é¡»å¯¼å…¥æ‰€æœ‰æ¨¡å‹ï¼
```

**ä¸ºä»€ä¹ˆå¿…é¡»å¯¼å…¥æ‰€æœ‰æ¨¡å‹ï¼Ÿ**
- Alembicéœ€è¦é€šè¿‡`Base.metadata`è·å–æ‰€æœ‰è¡¨ç»“æ„
- å¦‚æœä¸å¯¼å…¥æŸä¸ªæ¨¡å‹ï¼Œautogenerateä¼šè®¤ä¸ºå¯¹åº”çš„è¡¨éœ€è¦åˆ é™¤
- **é™·é˜±**ï¼šå¿˜è®°å¯¼å…¥æ–°æ¨¡å‹æ˜¯æ–°æ‰‹å¸¸çŠ¯çš„é”™è¯¯

---

## ğŸ¯ å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

### Step 1ï¼šé¡¹ç›®åˆå§‹åŒ–ï¼ˆå·²å®Œæˆï¼Œä»…ä¾›ç†è§£ï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆå§‹åŒ–Alembicï¼ˆå·²å®Œæˆï¼‰
cd backend
alembic init alembic

# ç”Ÿæˆçš„æ–‡ä»¶ç»“æ„ï¼š
backend/
â”œâ”€â”€ alembic.ini          # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ env.py          # ç¯å¢ƒè„šæœ¬ï¼ˆå·²è‡ªå®šä¹‰ï¼‰
â”‚   â”œâ”€â”€ script.py.mako  # è¿ç§»è„šæœ¬æ¨¡æ¿
â”‚   â””â”€â”€ versions/       # å­˜æ”¾æ‰€æœ‰è¿ç§»æ–‡ä»¶
â””â”€â”€ app/                # åº”ç”¨ä»£ç 
```

### Step 2ï¼šæŸ¥çœ‹å½“å‰æ•°æ®åº“çŠ¶æ€

```bash
# æ£€æŸ¥å½“å‰æ•°æ®åº“ç‰ˆæœ¬
alembic current

# è¾“å‡ºç¤ºä¾‹ï¼š
# INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
# INFO  [alembic.runtime.migration] Will assume transactional DDL.
# 9a6e37957675 (head)

# æŸ¥çœ‹è¿ç§»å†å²
alembic history --verbose

# è¾“å‡ºç¤ºä¾‹ï¼š
# Rev: 9a6e37957675 (head)
# Parent: <base>
# Path: /backend/alembic/versions/9a6e37957675_initial_database_schema_with_user_and_.py
#
#     Initial database schema with User and Proposal models
#
#     Revision ID: 9a6e37957675
#     Revises:
#     Create Date: 2025-11-15 11:56:02.526333
```

### Step 3ï¼šåˆ›å»ºæ–°çš„è¿ç§»ï¼ˆæ¨¡æ‹Ÿæ·»åŠ å­—æ®µï¼‰

å‡è®¾æˆ‘ä»¬è¦ç»™Userè¡¨æ·»åŠ ä¸€ä¸ªæ–°å­—æ®µ`bio`ï¼ˆä¸ªäººç®€ä»‹ï¼‰ï¼š

```bash
# Step 3.1: ä¿®æ”¹æ¨¡å‹ï¼ˆåœ¨app/models/user.pyä¸­æ·»åŠ ï¼‰
# bio = Column(String(1000), nullable=True, comment='ä¸ªäººç®€ä»‹')

# Step 3.2: ç”Ÿæˆè¿ç§»è„šæœ¬
alembic revision --autogenerate -m "add bio field to users"

# è¾“å‡ºç¤ºä¾‹ï¼š
# INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
# INFO  [alembic.runtime.migration] Will assume transactional DDL.
# INFO  [alembic.autogenerate.compare] Detected added column 'users.bio'
# Generating /backend/alembic/versions/ae1027a6acf_add_bio_field_to_users.py ... done

# Step 3.3: æ£€æŸ¥ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
cat alembic/versions/ae1027a6acf_add_bio_field_to_users.py
```

ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶ç¤ºä¾‹ï¼š
```python
"""add bio field to users

Revision ID: ae1027a6acf
Revises: 9a6e37957675
Create Date: 2025-11-15 14:30:15.123456

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = 'ae1027a6acf'
down_revision = '9a6e37957675'  # ğŸ”‘ æŒ‡å‘ä¸Šä¸€ä¸ªç‰ˆæœ¬

def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('bio', sa.String(length=1000), nullable=True, comment='ä¸ªäººç®€ä»‹'))
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'bio')
    # ### end Alembic commands ###
```

### Step 4ï¼šæ‰§è¡Œè¿ç§»

```bash
# Step 4.1: é¢„è§ˆå³å°†æ‰§è¡Œçš„SQLï¼ˆæ¨èï¼‰
alembic upgrade head --sql

# è¾“å‡ºSQLé¢„è§ˆï¼š
# INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
# INFO  [alembic.runtime.migration] Will assume transactional DDL.
# INFO  [alembic.runtime.migration] Running upgrade 9a6e37957675 -> ae1027a6acf, add bio field to users
# ALTER TABLE users ADD COLUMN bio VARCHAR(1000) COMMENT 'ä¸ªäººç®€ä»‹';
# UPDATE alembic_version SET version_num='ae1027a6acf' WHERE alembic_version.version_num = '9a6e37957675';

# Step 4.2: æ‰§è¡Œè¿ç§»
alembic upgrade head

# è¾“å‡ºç¤ºä¾‹ï¼š
# INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
# INFO  [alembic.runtime.migration] Will assume transactional DDL.
# INFO  [alembic.runtime.migration] Running upgrade 9a6e37957675 -> ae1027a6acf, add bio field to users

# Step 4.3: éªŒè¯ç»“æœ
alembic current
# ae1027a6acf (head)
```

### Step 5ï¼šå›æ»šæ“ä½œï¼ˆå¦‚éœ€è¦ï¼‰

```bash
# å›æ»šä¸€ä¸ªç‰ˆæœ¬
alembic downgrade -1

# è¾“å‡ºç¤ºä¾‹ï¼š
# INFO  [alembic.runtime.migration] Running downgrade ae1027a6acf -> 9a6e37957675, add bio field to users

# å›æ»šåˆ°ç‰¹å®šç‰ˆæœ¬
alembic downgrade 9a6e37957675

# å›æ»šåˆ°åŸºç¡€ç‰ˆæœ¬ï¼ˆæ¸…ç©ºæ•°æ®åº“ï¼‰
alembic downgrade base
```

---

## âš ï¸ å¸¸è§é™·é˜±ï¼ˆæ–°æ‰‹å¿…çœ‹ï¼‰

### é™·é˜± 1ï¼šå¿˜è®°å¯¼å…¥æ–°æ¨¡å‹åˆ° env.py

```python
# âŒ é”™è¯¯ï¼šåˆ›å»ºäº†æ–°æ¨¡å‹ä½†æ²¡æœ‰å¯¼å…¥
# æ–‡ä»¶ï¼šapp/models/comment.py
class Comment(Base):
    __tablename__ = "comments"
    id = Column(Integer, primary_key=True)
    content = Column(Text, nullable=False)

# æ–‡ä»¶ï¼šalembic/env.py
from app.models import user, proposal
# å¿˜è®°å¯¼å…¥ comment æ¨¡å—ï¼

# ç»“æœï¼šè¿è¡Œ autogenerate æ—¶ä¼šæç¤ºåˆ é™¤ comments è¡¨
alembic revision --autogenerate -m "test"
# Detected removed table 'comments'  # âŒ é”™è¯¯æ£€æµ‹ï¼

# âœ… æ­£ç¡®ï¼šå¯¼å…¥æ‰€æœ‰æ¨¡å‹
from app.models import user, proposal, comment  # âœ… æ·»åŠ comment
```

**è§£å†³æ–¹æ¡ˆ**ï¼šæ¯æ¬¡æ·»åŠ æ–°æ¨¡å‹æ—¶ï¼Œè®°å¾—åœ¨`env.py`ä¸­å¯¼å…¥ã€‚

### é™·é˜± 2ï¼šæ•°æ®åº“URLé…ç½®é”™è¯¯

```python
# âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨å¼‚æ­¥URL
# alembic.ini
sqlalchemy.url = postgresql+asyncpg://user:pass@localhost/db

# è¿è¡Œæ—¶æŠ¥é”™ï¼š
# sqlalchemy.exc.ArgumentError: postgresql+asyncpg dialect is not supported

# âœ… æ­£ç¡®ï¼šåœ¨env.pyä¸­è½¬æ¢URL
database_url = settings.DATABASE_URL
if "+asyncpg" in database_url:
    database_url = database_url.replace("+asyncpg", "")
config.set_main_option("sqlalchemy.url", database_url)
```

### é™·é˜± 3ï¼šæ‰‹åŠ¨ä¿®æ”¹è¿ç§»åä¸åŒ¹é…

```python
# âŒ é”™è¯¯æ“ä½œåºåˆ—ï¼š
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
alembic revision --autogenerate -m "add email column"

# 2. æ‰‹åŠ¨ä¿®æ”¹è¿ç§»æ–‡ä»¶ï¼ˆæ”¹å˜å­—æ®µç±»å‹ï¼‰
# op.add_column('users', sa.Column('email', sa.String(50)))  # åŸï¼š50é•¿åº¦
# op.add_column('users', sa.Column('email', sa.String(100))) # æ”¹ï¼š100é•¿åº¦

# 3. æ‰§è¡Œè¿ç§»
alembic upgrade head

# 4. å†æ¬¡è¿è¡Œautogenerate
alembic revision --autogenerate -m "test"
# Detected type change from VARCHAR(100) to VARCHAR(50)  # âŒ ä¸ä¸€è‡´ï¼

# âœ… æ­£ç¡®æ–¹æ¡ˆï¼š
# æ–¹æ¡ˆ1ï¼šä¿®æ”¹è¿ç§»æ–‡ä»¶åï¼ŒåŒæ—¶ä¿®æ”¹ORMæ¨¡å‹ä¿æŒä¸€è‡´
# æ–¹æ¡ˆ2ï¼šåˆ é™¤è¿ç§»æ–‡ä»¶ï¼Œä¿®æ”¹ORMæ¨¡å‹ï¼Œé‡æ–°ç”Ÿæˆè¿ç§»
```

### é™·é˜± 4ï¼šç”Ÿäº§ç¯å¢ƒç›´æ¥è¿è¡Œ autogenerate

```bash
# âŒ å±é™©ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒç›´æ¥è¿è¡Œ
# ç”Ÿäº§æœåŠ¡å™¨
alembic revision --autogenerate -m "fix typo"
# å¯èƒ½æ£€æµ‹åˆ°æ„å¤–çš„å·®å¼‚ï¼Œäº§ç”Ÿå±é™©çš„è¿ç§»

# âœ… æ­£ç¡®æµç¨‹ï¼š
# 1. å¼€å‘ç¯å¢ƒï¼šåˆ›å»ºå’Œæµ‹è¯•è¿ç§»
alembic revision --autogenerate -m "add new feature"
alembic upgrade head  # æµ‹è¯•è¿ç§»

# 2. ç‰ˆæœ¬æ§åˆ¶ï¼šæäº¤è¿ç§»æ–‡ä»¶
git add alembic/versions/æ–°è¿ç§»æ–‡ä»¶.py
git commit -m "feat: add new feature migration"

# 3. ç”Ÿäº§ç¯å¢ƒï¼šåªæ‰§è¡Œå·²æœ‰è¿ç§»
git pull  # è·å–æ–°è¿ç§»æ–‡ä»¶
alembic upgrade head  # æ‰§è¡Œè¿ç§»
```

### é™·é˜± 5ï¼šå¤šäººåä½œæ—¶çš„ç‰ˆæœ¬å†²çª

```bash
# åœºæ™¯ï¼šä¸¤ä¸ªå¼€å‘è€…åŒæ—¶åˆ›å»ºè¿ç§»

# å¼€å‘è€…Aï¼š
alembic revision --autogenerate -m "add user bio"
# ç”Ÿæˆï¼šae1027a6acf_add_user_bio.py
# down_revision = '9a6e37957675'

# å¼€å‘è€…Bï¼ˆåŒæ—¶è¿›è¡Œï¼‰ï¼š
alembic revision --autogenerate -m "add user avatar"
# ç”Ÿæˆï¼š1b2c3d4e5f6_add_user_avatar.py
# down_revision = '9a6e37957675'  # ğŸ”¥ å†²çªï¼ä¸¤ä¸ªè¿ç§»éƒ½æŒ‡å‘åŒä¸€ä¸ªçˆ¶ç‰ˆæœ¬

# åˆå¹¶ä»£ç åè¿è¡ŒæŠ¥é”™ï¼š
# Multiple heads detected

# âœ… è§£å†³æ–¹æ¡ˆï¼šåˆ›å»ºåˆå¹¶è¿ç§»
alembic merge -m "merge user bio and avatar" ae1027a6acf 1b2c3d4e5f6
# ç”Ÿæˆåˆå¹¶è¿ç§»ï¼šc7d8e9f0a1b2_merge_user_bio_and_avatar.py
# down_revision = ('ae1027a6acf', '1b2c3d4e5f6')
```

---

## ğŸ“š å­¦ä¹ èµ„æº

### å®˜æ–¹èµ„æº
- **Alembic å®˜æ–¹æ–‡æ¡£**ï¼šhttps://alembic.sqlalchemy.org/
- **Context7 æŸ¥è¯¢ç»“æœ**ï¼š`/sqlalchemy/alembic` (å·²æŸ¥è¯¢)
- **SQLAlchemy è¿ç§»æŒ‡å—**ï¼šhttps://docs.sqlalchemy.org/en/20/orm/declarative_config.html#alembic-configuration

### é¡¹ç›®ä¸­çš„å‚è€ƒæ–‡ä»¶
- **é…ç½®æ–‡ä»¶**ï¼š`backend/alembic.ini` - Alembicä¸»é…ç½®
- **ç¯å¢ƒè„šæœ¬**ï¼š`backend/alembic/env.py` - è¿ç§»è¿è¡Œç¯å¢ƒ
- **è¿ç§»ç¤ºä¾‹**ï¼š`backend/alembic/versions/9a6e37957675_initial_database_schema_with_user_and_.py` - å®Œæ•´è¿ç§»æ–‡ä»¶
- **æ¨¡å‹å®šä¹‰**ï¼š`backend/app/models/user.py:39` - Useræ¨¡å‹ç»“æ„
- **æ•°æ®åº“é…ç½®**ï¼š`backend/app/db/session.py:84` - è¿æ¥é…ç½®

---

## ğŸ¯ å®è·µç»ƒä¹ å»ºè®®

### ç»ƒä¹  1ï¼šæŸ¥çœ‹é¡¹ç›®è¿ç§»å†å²
```bash
cd backend
alembic history --verbose
alembic current
alembic show head
```

### ç»ƒä¹  2ï¼šæ¨¡æ‹Ÿæ·»åŠ å­—æ®µï¼ˆä¸è¦å®é™…æ‰§è¡Œï¼‰
```bash
# åªç”ŸæˆSQLé¢„è§ˆï¼Œä¸å®é™…æ‰§è¡Œ
alembic upgrade head --sql

# æŸ¥çœ‹ç‰¹å®šç‰ˆæœ¬çš„è¯¦ç»†ä¿¡æ¯
alembic show 9a6e37957675
```

### ç»ƒä¹  3ï¼šç†è§£è¿ç§»æ–‡ä»¶ç»“æ„
- æ‰“å¼€ `backend/alembic/versions/9a6e37957675_*.py`
- é˜…è¯» upgrade å’Œ downgrade å‡½æ•°
- ç†è§£ revision æ ‡è¯†ç¬¦çš„ä½œç”¨

---

## âœ… å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼Œè¯´æ˜ä½ å·²ç»æŒæ¡ Alembic æ•°æ®åº“è¿ç§»ï¼š

- [ ] **ç†è§£è¿ç§»æ¦‚å¿µ**ï¼šèƒ½è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶
- [ ] **ç†è§£ç‰ˆæœ¬é“¾æ¡**ï¼šçŸ¥é“ revisionã€down_revision çš„å…³ç³»
- [ ] **ä¼šè¯»å–è¿ç§»æ–‡ä»¶**ï¼šç†è§£ upgrade å’Œ downgrade å‡½æ•°çš„ä½œç”¨
- [ ] **ä¼šä½¿ç”¨åŸºç¡€å‘½ä»¤**ï¼šcurrentã€historyã€showã€upgradeã€downgrade
- [ ] **ç†è§£ autogenerate**ï¼šçŸ¥é“å®ƒå¦‚ä½•æ£€æµ‹æ¨¡å‹å˜åŒ–
- [ ] **çŸ¥é“é…ç½®è¦ç‚¹**ï¼šenv.py ä¸­å¿…é¡»å¯¼å…¥æ‰€æœ‰æ¨¡å‹
- [ ] **çŸ¥é“URLè½¬æ¢åŸå› **ï¼šasyncpg vs psycopg2 çš„å…¼å®¹æ€§é—®é¢˜
- [ ] **èƒ½é¿å…å¸¸è§é™·é˜±**ï¼šç‰ˆæœ¬å†²çªã€æ¨¡å‹ä¸ä¸€è‡´ç­‰
- [ ] **ç†è§£å›¢é˜Ÿåä½œæµç¨‹**ï¼šå¼€å‘ç¯å¢ƒç”Ÿæˆï¼Œç”Ÿäº§ç¯å¢ƒæ‰§è¡Œ

---

## ğŸ“ ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆæœ¬æ–‡æ¡£åï¼Œå»ºè®®ç»§ç»­å­¦ä¹ ï¼š

1. **è®¤è¯ç³»ç»Ÿ**ï¼š`04_jwt_authentication.md` - ç»“åˆè¿ç§»ç†è§£ç”¨æˆ·è®¤è¯
2. **ä¾èµ–ç®¡ç†**ï¼š`05_poetry_dependency_management.md` - Poetry åŒ…ç®¡ç†
3. **é¡¹ç›®å®æˆ˜**ï¼šå°è¯•ä¸º Proposal æ¨¡å‹æ·»åŠ æ–°å­—æ®µ
4. **é«˜çº§ç‰¹æ€§**ï¼šå­¦ä¹ åˆ†æ”¯è¿ç§»ã€æ•°æ®è¿ç§»ã€è‡ªå®šä¹‰æ“ä½œç±»å‹

---

## ğŸš€ å®é™…é¡¹ç›®åº”ç”¨

**åœ¨ InnoLiber é¡¹ç›®ä¸­çš„ä½¿ç”¨åœºæ™¯**ï¼š

1. **Phase 2.1 å®Œæˆ**ï¼šåˆå§‹æ•°æ®åº“ç»“æ„å·²é€šè¿‡è¿ç§»åˆ›å»º
2. **æœªæ¥å¼€å‘**ï¼šæ¯æ¬¡æ¨¡å‹ä¿®æ”¹éƒ½ä¼šç”Ÿæˆæ–°çš„è¿ç§»æ–‡ä»¶
3. **å›¢é˜Ÿåä½œ**ï¼šæ–°æˆå‘˜ `alembic upgrade head` å³å¯è·å¾—ç›¸åŒæ•°æ®åº“ç»“æ„
4. **éƒ¨ç½²æµç¨‹**ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ—¶è‡ªåŠ¨æ‰§è¡Œ `alembic upgrade head`

**é¡¹ç›®ç‰¹è‰²é…ç½®**ï¼š
- âœ… æ”¯æŒå¼‚æ­¥ SQLAlchemy 2.0
- âœ… è‡ªåŠ¨ URL è½¬æ¢ï¼ˆasyncpg â†” psycopg2ï¼‰
- âœ… å®Œæ•´çš„ä¸­æ–‡å­—æ®µæ³¨é‡Š
- âœ… JSON å­—æ®µæ”¯æŒï¼ˆAIè¯„åˆ†ã€å…³é”®è¯ç­‰ï¼‰
- âœ… å¤–é”®çº¦æŸå’Œçº§è”åˆ é™¤

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-11-15
**ç»´æŠ¤è€…**ï¼šInnoLiber Team
**å‚è€ƒæ¥æº**ï¼šContext7 - SQLAlchemy Alembic å®˜æ–¹æ–‡æ¡£