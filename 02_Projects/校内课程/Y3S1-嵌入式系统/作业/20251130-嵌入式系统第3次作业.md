---
created: 2025-11-30
version: v1.0.0
tags:
  - 作业
---

# 作业

1. STM32F4系列芯片中，Cortex-M4内核的I-bus、D-bus和S-bus分别可以访问哪些设备？
2. 如果要完成STM32F407的UART2与内存的DMA数据交换，需要使用哪个DMA控制器？需要配置哪些与DMA相关的寄存器？如何配置?
3. CAN总线作为多主竞争型总线，是如何完成总线仲裁的？并用3个CAN节点的竞争和仲裁例子说明过程？
4. 分析NOR型Flash和NAND型Flash的特点，并说明为什么NOR型的适合存放代码，NAND型的适合存放大数据？
5. 请总结STM32F4系列芯片是如何管理存储空间的？


# 答案

## Q1

1. I-bus：用于 CPU 内核进行**取指令操作**，可以访问存储器中包含的代码。
2. D-bus：用于 CPU 内核进行**数据加载**和**调试访问**，可以访问存储器中包含的代码和数据。
3. S-bus：用于 CPU 内核进行访问位于**外设**或 **SRAM** 中的数据，可以访问SRAM1，SRAM2，AHB1外设，AHB2外设，通过FSMC扩展的内存。

## Q2


UART2挂载在APB1总线上，数据传输由DMA1负责。所以具体数据交换方式见下表：

|**功能**|**方向**|**DMA控制器**|**数据流 (Stream)**|**通道 (Channel)**|
|---|---|---|---|---|
|**UART2_RX**|外设 $\rightarrow$ 内存|**DMA1**|**Stream 5**|**Channel 4**|
|**UART2_TX**|内存 $\rightarrow$ 外设|**DMA1**|**Stream 6**|**Channel 4**|

寄存器配置需要操作两类寄存器：DMA侧寄存器和UART侧寄存器。
1. DMA侧寄存器：
	1. **`DMA_SxCR` (Stream x Configuration Register)**: 核心配置寄存器。用于设置通道选择、数据方向、优先级、数据宽度、增量模式、循环模式等。
	2. **`DMA_SxNDTR` (Number of Data Register)**: 数据传输数量寄存器。设置要传输多少个字节。
	3. **`DMA_SxPAR` (Peripheral Address Register)**: 外设地址寄存器。存放UART2的数据寄存器地址 (`&USART2->DR`)。
	4. **`DMA_SxM0AR` (Memory 0 Address Register)**: 存储器地址寄存器。存放你的Buffer（数组）的地址。
2. UART侧寄存器：
	1. **`USART_CR3` (Control Register 3)**: 控制寄存器3。需要开启UART的DMA请求功能。

配置方法：
UART2_RX：开启使用，配置DMA1_Stream5（针对UART2_RX），之后配置UART2侧


## Q3

在 CAN 协议中，仲裁是基于报文的 **ID 标识符**进行的
- 报文标识符（ID）的值决定了报文的优先级。**ID 值越低，优先级越高**
- 当多个节点同时尝试发送报文时，它们会同时监测总线，进行非破坏性（non-destructive）的位级仲裁。高优先级的报文（ID 值低）会赢得总线访问权，而低优先级的报文会暂停发送，直到总线空闲。
假设有三个 CAN 节点同时尝试在总线上发送报文：

|          |            |        |        |
| -------- | ---------- | ------ | ------ |
| 节点       | 报文标识符 (ID) | 优先级    | 报文内容   |
| **节点 A** | ID = 0x100 | **中等** | 速度控制信息 |
| **节点 B** | ID = 0x010 | **最高** | 紧急制动信号 |
| **节点 C** | ID = 0x200 | **最低** | 诊断日志数据 |
1. 竞争：发送报文ID
2. 位级比较：
	1. 节点B的ID更小，更早发送显性位故优先级高
	2. 节点A和节点C优先级较低，故会立即停止发送并进入监听模式
	3. 节点B信息发送
	4. 发送后总线空闲，A和C再次比较，进入下一轮循环


## Q4

NOR与NAND的对比：

|**特性**|**NOR Flash**|**NAND Flash**|
|---|---|---|
|**硬件接口**|**独立地址线/数据线** (类似 SRAM)|**共用 I/O 口** (地址/数据复用)|
|**寻址单位**|**字节 (Byte)**|**页 (Page)**|
|**读取速度**|**极快** (随机读取)|慢 (特别是随机读取)|
|**写入/擦除速度**|慢|**极快**|
|**存储密度/容量**|低 (通常 1MB ~ 256MB)|**极高** (128MB ~ TB级别)|
|**成本 (每Bit)**|高|**低**|
|**坏块情况**|几乎无坏块，可靠性极高|出厂即可能存在坏块，需ECC校验|
|**主要用途**|**代码存储 (BIOS, Firmware)**|**大容量数据存储 (SSD, SD卡)**|
NOR适合存放代码是因为：
1. 支持芯片内执行，NOR Flash有完整的地址总线和数据总线，CPU可以像访问RAM一样通过地址直接访问NOR Flash中的任何一个字节。
2. NOR Flash的数据可靠性和读取稳定性高

NAND适合存放大数据：
1. NAND内部存储单元串联，结构去除每个单元的接触点，使得同样硅片面积NAND可以容纳比NOR多得多的存储单元。
2. NAND可以通过8位或者16位的I/O口串行发送命令和地址，以页为单位读取，以块为单位擦除。



## Q5

STM32F4 系列（基于 Cortex-M4 内核）对存储空间的管理采用的是 **32位统一编址（Flat Address Space）**，即将代码存储器、数据存储器、外设寄存器以及外部扩展存储器全部映射到4GB的线性地址空间中。
1. 内存映射：

|**块 (Block)**|**地址范围**|**主要用途**|**关键说明**|
|---|---|---|---|
|**Block 0**|`0x0000 0000` - `0x1FFF FFFF`|**代码区 (Code)**|存放 Flash、System Memory (Bootloader) 等。|
|**Block 1**|`0x2000 0000` - `0x3FFF FFFF`|**片内 SRAM**|存放变量、堆栈。支持位带操作。|
|**Block 2**|`0x4000 0000` - `0x5FFF FFFF`|**片上外设**|APB1, APB2, AHB1, AHB2 等总线挂载的外设寄存器。|
|**Block 3-4**|`0x6000 0000` - `0x9FFF FFFF`|**FSMC 扩展区**|用于连接外部 SRAM, NOR/NAND Flash, LCD 等。|
|**Block 7**|`0xE000 0000` - `0xFFFF FFFF`|**Cortex-M4 内部外设**|NVIC, SysTick 等内核组件。|
2. Flash程序存储器管理：
- **扇区 (Sector) 划分**： 与某些芯片统一页大小不同，F4 的 Flash 扇区大小是不均匀的。通常前 4 个扇区较小（16KB，用于存放中断向量表和启动代码），后面的扇区较大（128KB，用于存放主程序或大数据）。        
- **多块结构**： 高性能的 F4（如 F407/F429）通常有 1MB 或更大的 Flash，它们可能被分为 **Bank 1** 和 **Bank 2**，支持双从未读写（Dual Bank），即在一个 Bank 运行程序时擦写另一个 Bank。

2. SRAM (数据存储器) 管理：
	1. System SRAM：主RAM，挂载在总线矩阵上，CPU和DMA都可以访问
	2. CCM RAM：直接连接到D-bus，只有CPU可以访问
	3. Backup SRAM：由电池供电，掉电后数据不丢失

3. 地址重映射：
	1. Main Flash Memory（BOOT0=0）
	2. System Memory（BOOT0=1，BOOT1=0）
	3. SRAM（BOOT0=1，BOOT1=1）

4. 位带操作
5. FSMC/FMC，静态存储控制器，将外部存储芯片直接映射到内部地址空间的Block3和Block4

